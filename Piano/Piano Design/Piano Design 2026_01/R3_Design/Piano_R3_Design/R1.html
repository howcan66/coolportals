<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R1 - Chord Input & Validation Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #1a1a1a;
            color: #ffffff;
            padding: 20px;
            display: flex;
            gap: 20px;
        }

        #r1-panel {
            width: 15%;
            min-width: 200px;
            background-color: #2b2b2b;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 20px;
        }

        .r1-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .r1-header h2 {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .r1-timestamp {
            font-size: 0.75rem;
            color: #888;
        }

        .r1-help-text {
            font-size: 0.85rem;
            color: #ddd;
            margin-bottom: 12px;
            line-height: 1.3;
        }

        .r1-rows-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 16px;
        }

        .r1-row {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .r1-textform {
            flex: 1;
            padding: 6px 8px;
            border: 1px solid #555;
            border-radius: 4px;
            font-family: Arial, sans-serif;
            font-size: 0.9rem;
            background-color: #ffffff;
            color: #000;
            max-width: 100px;
            transition: border-color 0.2s;
        }

        .r1-textform:focus {
            outline: none;
            border-color: #8fd694;
        }

        .r1-textform:invalid {
            border-color: #555;
        }

        .r1-btn-row {
            display: flex;
            gap: 4px;
        }

        .r1-btn {
            width: 28px;
            height: 28px;
            padding: 0;
            border: none;
            border-radius: 3px;
            font-size: 0.75rem;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .r1-btn:hover {
            opacity: 0.8;
        }

        .r1-btn:active {
            opacity: 0.6;
        }

        .r1-btn-load {
            background-color: #8fd694;
            color: white;
        }

        .r1-btn-clear {
            background-color: #f4a6a6;
            color: white;
        }

        .r1-global-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #444;
        }

        .r1-btn-global {
            flex: 1;
            padding: 8px 0;
            border: 2px solid;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.2s;
            min-width: 50px;
        }

        .r1-btn-global:hover {
            opacity: 0.8;
        }

        .r1-btn-global:active {
            opacity: 0.6;
        }

        .r1-btn-load-all {
            background-color: transparent;
            border-color: #8fd694;
            color: #8fd694;
        }

        .r1-btn-clear-all {
            background-color: #f4a6a6;
            border-color: #f4a6a6;
            color: white;
        }

        .r1-footer {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #444;
            font-size: 0.7rem;
            color: #666;
            text-align: center;
            line-height: 1.3;
        }

        #r3-placeholder {
            flex: 1;
            background-color: #2b2b2b;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 1.2rem;
        }
    </style>
</head>
<body>

<section id="r1-panel">
    <div class="r1-header">
        <h2>R1</h2>
        <div class="r1-timestamp" id="r1-timestamp">26.01.24 • 14.37</div>
    </div>

    <div class="r1-help-text">
        Ackordinmatning: börja med rottecken (A–G/H), följ R1.X regler
    </div>

    <div class="r1-global-buttons">
        <button class="r1-btn-global r1-btn-load-all" id="r1-b3" aria-label="Load All to R3">LR3</button>
        <button class="r1-btn-global r1-btn-clear-all" id="r1-b4" aria-label="Clear All">XR1</button>
    </div>

    <div class="r1-rows-container" id="r1-rows-container">
        <!-- Rows generated here -->
    </div>

    <div class="r1-footer">
        R1: Validate → R3: Display<br>
        Shift+Enter = B3 (Load All)
    </div>
</section>

<div id="r3-placeholder">
    R3 Display (pianogroups) will appear here →
</div>

<script>
    // ===== R1 CHORD VALIDATION =====
    
    const CHORD_REGEX = /^(?=.{1,10}$)[A-GH](?:#|b)?(?:maj|m|dim|aug|sus)?(?:2|4|5|6|7|9|11|13)?(?:(?:#|b)(?:5|9|11|13))?(?:add(?:9|11|13))?$/i;

    function validateChord(chord) {
        const trimmed = chord.trim();
        if (!trimmed) return null;
        if (!CHORD_REGEX.test(trimmed)) return null;
        
        // Check for duplicate add/extension
        const match = trimmed.match(/(\d+).*add(\d+)/i);
        if (match && match[1] === match[2]) return null;
        
        // Normalize H→B
        return trimmed.replace(/^H/i, 'B');
    }

    // ===== AUDIO PLAYBACK =====
    
    function playChordSound(chordName, delayMs = 0) {
        // Placeholder for audio engine (Tone.js or Web Audio API)
        // In production, this would synthesize the chord
        console.log(`Playing chord: ${chordName} (delay: ${delayMs}ms)`);
    }

    // ===== R1 INITIALIZATION =====
    
    function initR1() {
        generateRows();
        attachRowListeners();
        attachGlobalListeners();
        updateTimestamp();
    }

    // ===== ROW GENERATION =====
    
    function generateRows() {
        const container = document.getElementById('r1-rows-container');
        for (let i = 1; i <= 10; i++) {
            const row = document.createElement('div');
            row.className = 'r1-row';
            row.innerHTML = `
                <input 
                    type="text" 
                    class="r1-textform" 
                    id="r1-textform-${i}"
                    placeholder="Ex: Cmaj7"
                    maxlength="10"
                    aria-label="Row ${i}"
                />
                <div class="r1-btn-row">
                    <button class="r1-btn r1-btn-load" data-row="${i}" data-action="load" aria-label="Load Row ${i} to R3">L</button>
                    <button class="r1-btn r1-btn-clear" data-row="${i}" data-action="clear" aria-label="Clear Row ${i}">X</button>
                </div>
            `;
            container.appendChild(row);
        }
    }

    // ===== EVENT LISTENERS =====
    
    function attachRowListeners() {
        document.querySelectorAll('.r1-btn-row').forEach(container => {
            container.addEventListener('click', (e) => {
                if (!e.target.classList.contains('r1-btn')) return;
                
                const rowIndex = parseInt(e.target.dataset.row);
                const action = e.target.dataset.action;
                
                if (action === 'load') {
                    handleB1Click(rowIndex);
                } else if (action === 'clear') {
                    handleB2Click(rowIndex);
                }
            });
        });

        // Validate on blur
        document.querySelectorAll('.r1-textform').forEach(input => {
            input.addEventListener('blur', (e) => {
                const chord = e.target.value.trim();
                if (chord && !validateChord(chord)) {
                    e.target.value = ''; // Clear invalid chords silently
                }
            });
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && e.shiftKey) {
                handleB3Click();
            }
        });
    }

    function attachGlobalListeners() {
        document.getElementById('r1-b3').addEventListener('click', handleB3Click);
        document.getElementById('r1-b4').addEventListener('click', handleB4Click);
    }

    // ===== B1: LOAD ROW TO R3 =====
    
    window.handleB1Click = function(rowIndex) {
        const input = document.getElementById(`r1-textform-${rowIndex}`);
        if (!input) return;

        const chord = input.value.trim();
        
        if (!chord) {
            // Empty field: keep existing R3 value (no change)
            return;
        }
        
        const validated = validateChord(chord);
        if (!validated) {
            // Invalid chord: clear field silently per R1.XC
            input.value = '';
            return;
        }
        
        // Valid chord: transfer to R3 using API contract
        if (window.R3 && window.R3.receiveChordFromR1) {
            window.R3.receiveChordFromR1(validated, rowIndex);
        }
        
        // Play sound
        playChordSound(validated, 400);
    };

    // ===== B2: CLEAR ROW =====
    
    function handleB2Click(rowIndex) {
        const input = document.getElementById(`r1-textform-${rowIndex}`);
        if (input) input.value = '';
        
        // Clear R3 pianogroup using API contract
        if (window.R3 && window.R3.clearPianoGroup) {
            window.R3.clearPianoGroup(rowIndex);
        }
        
        // No sound
    }

    // ===== B3: LOAD ALL TO R3 =====
    
    function handleB3Click() {
        // Collect all 10 chords
        const chordArray = [];
        const r1Inputs = document.querySelectorAll('.r1-textform');
        
        r1Inputs.forEach((input) => {
            const chord = input.value.trim();
            
            if (!chord) {
                chordArray.push(""); // Empty string for cleared/blank rows
                return;
            }
            
            const validated = validateChord(chord);
            if (!validated) {
                input.value = ''; // Clear invalid chords
                chordArray.push("");
                return;
            }
            
            chordArray.push(validated); // Add valid chord to array
        });
        
        // Send entire batch to R3 using API contract
        if (window.R3 && window.R3.receiveChordBatch) {
            window.R3.receiveChordBatch(chordArray);
        } else {
            // Fallback: iterate and call receiveChordFromR1 for each row with 400ms gaps
            let soundDelay = 0;
            chordArray.forEach((chord, index) => {
                if (chord && window.R3 && window.R3.receiveChordFromR1) {
                    setTimeout(() => {
                        window.R3.receiveChordFromR1(chord, index + 1);
                        playChordSound(chord);
                    }, soundDelay);
                    soundDelay += 400;
                }
            });
        }
    }

    // ===== B4: CLEAR ALL =====
    
    function handleB4Click() {
        const r1Inputs = document.querySelectorAll('.r1-textform');
        r1Inputs.forEach((input, index) => {
            input.value = '';
            
            // Clear each R3 pianogroup using API contract
            if (window.R3 && window.R3.clearPianoGroup) {
                window.R3.clearPianoGroup(index + 1);
            }
        });
        
        // No sound
    }

    // ===== TIMESTAMP =====
    
    function updateTimestamp() {
        const now = new Date();
        const yy = String(now.getFullYear()).slice(-2);
        const mm = String(now.getMonth() + 1).padStart(2, '0');
        const dd = String(now.getDate()).padStart(2, '0');
        const hh = String(now.getHours()).padStart(2, '0');
        const mins = String(now.getMinutes()).padStart(2, '0');
        
        document.getElementById('r1-timestamp').textContent = `${yy}.${mm}.${dd} • ${hh}.${mins}`;
    }

    // ===== INITIALIZATION =====
    
    document.addEventListener('DOMContentLoaded', initR1);
</script>

</body>
</html>

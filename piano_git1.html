<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <title>Pianoackordverktyg – piano_git1 (HL-Spec V3.5)</title>
  <style>
    /* Basic styles (kept minimal here) */
    body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
    .app { display: flex; gap: 20px; }
    #r1 { width: 260px; padding: 10px; border-right: 1px solid #ccc; box-sizing: border-box; margin-bottom: 20px; }
    #right { flex: 1; padding: 10px; box-sizing: border-box; margin-bottom: 20px; }
    .r1-row { display: flex; align-items: center; gap: 6px; margin-bottom: 6px; }
    .r1-label { width: 30px; }
    .r1-input { flex: 1; }
    .r3-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
    .r3-chords { flex: 1; display: flex; flex-wrap: wrap; gap: 6px; }
    .r3-chord-label { background:#f0f0f0; padding:4px 6px; border-radius:4px; }
    .piano { position: relative; height: 90px; background:#eee; }
    .white-keys { display:flex; }
    .white-key { width:28px; height:90px; border:1px solid #ccc; box-sizing:border-box; display:flex; align-items:flex-end; justify-content:center; font-size:12px; }
    .black-keys { position:absolute; top:0; left:0; height:60px; pointer-events:none; }
    .black-key { position:absolute; width:18px; height:60px; background:#333; color:#fff; display:flex; align-items:flex-end; justify-content:center; font-size:11px; }
    .note-red { color: red !important; font-weight: bold; }
    .piano.r3-size { height: 90px; }
    .piano.r2b-size { height: 130px; margin-bottom: 20px; }
    .circle-btn { width:28px; height:28px; border-radius:50%; }
    #r2a, #r2b, #r3 {
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
<div class="app">
  <!-- Vänsterkolumn R1 -->
  <div id="r1">
    <div id="r1-title">Pianoackord (R1)</div>
    <div id="r1-rows"></div>
    <div id="r1-help">
      <!-- Intruction Help Layout: -->
      <!-- +--------+---------+---------+ -->
      <!-- |        |  R2A    |  R2B    | -->
      <!-- |  R1    |(text)   |(analys) | -->
      <!-- |        +---------+---------+ -->
      <!-- |        |        R3         | -->
      <!-- |        |  (ackordslista)   | -->
      <!-- +--------+-------------------+ -->
      <!-- Intruction R1 Help Layout: -->
      <!-- RAM R1 is leftframe. Left frame. It gets data from RAM R2A    -->
      <!-- RAM R1 has input text field and an ok button and a reset button and helptext infomration -->
      <!-- RAM R1 has Ok button labelled "OK" will load data to frame R3--> 
      <!-- RAM R1 has Ok button labelled "Reset" will empty all the data in frame R1--> 
      <!-- RAM R1 has helptext information Date Version "Actual Date" "Actual Version" -->
      <!-- RAM R1 has helptext information "Use capitol letters"                       -->
      <!-- RAM R1 has helptext information "Blank to separate chords" -                -->
      <!-- RAM R1 Present frames in Ascii format in the bottom of page                  -->
      
      <!-- RAM R2A Data is a textform with odd rows for chords and even rows for text  -->
      <!-- RAM R2A Data is seperated with blanks only valid chord combinations should be loaded to RAM R1 -->
      <!-- In R2A use standardnotation C, Dm, Fmaj7, G7, A#. -->
      <!-- RAM R2A Has two buttons. One for Load chords labelled Load. Second Reset. To reset text form in R2A -->
      <!-- RAM R2A Press 'Load' all valid chords are added to the R1 list of data. chord by chord into the rows -->
      <!-- RAM R2A Press 'Reset' R2A frorm is emptied -->
      
      <!-- RAM3 Layout start with one piano chord based on R1 data. A label with the chord should be presented -->
      <!-- RAM3 Piano chord should be presented as one octave in graphical keys  --> 
      <!-- Keyboard C to B for with keys and responding the black keys           -->
      <!-- RAM3 Piano chord shall have the actual individual notes on the keys    -->
      <!-- RAM3 Piano chord shall 3 buttons under the chord    -->
      <!-- RAM3 Piano chord button1 triad. Pressing buttoh should present the triad version in R2B -->
      <!-- RAM3 Piano chord button2 tetrad. Pressing buttoh should present the triad version in R2B -->
      <!-- RAM3 Piano chord button3 Inversion/ALT. Pressing buttoh should present the Inversion/ALT version in R2B -->

      <!-- RAM R2B Layout is using the existing frame adding a label "Analysis / Alternative Chords" -->
      
      <!--RAM R2B Present the selected chord over 2 octaves piano keyboar -->
      <!--RAM R2B Present the selected chord and its type decided by the button in R3 -->
      <!--RAM R2B Present the piano graphics and its type decided by the button in R3 -->
      
      <!-- RAM R2B Shall present an analyse text "Analyse" and result not decided yet -->
      <!-- Piano tests - To B Defined -->
      
      
    </div>
    <div id="r1-controls">
      <button id="btn-load-all">Ladda alla</button>
      <button id="btn-clear-all">Rensa alla</button>
    </div>
    <div id="r1-footer">
      HL‑Spec V3.5
    </div>
  </div>
  <!-- Högerdel -->
  <div id="right">
    <div id="top-row">
      <!-- R2A -->
      <div id="r2a">
        <div><strong>R2A – Textinmatning</strong></div>
        <textarea id="r2a-text" spellcheck="false" style="width:100%;height:120px;"></textarea>
        <div id="r2a-controls">
          <button id="btn-r2a-load">Ladda</button>
          <button id="btn-r2a-clear">Rensa</button>
        </div>
      </div>
      <!-- R2B -->
      <div id="r2b">
        <div id="r2b-title"><strong>R2B – Analys</strong></div>
        <div id="r2b-label"></div>
        <div id="r2b-piano"></div>
        <div style="margin-top:6px;">
          <button id="btn-r2b-clear">Rensa</button>
        </div>
      </div>
    </div>
    <!-- R3 -->
    <div id="r3">
      <div><strong>R3 – Ackordslista</strong></div>
      <div id="r3-rows"></div>
    </div>
  </div>
</div>
<script>
  const R1_ROWS = 28;
  const R3_ROWS = 28;
  const rootToTriad = {
    'C': ['C','E','G'],
    'C#': ['C#','F','G#'],
    'D': ['D','F#','A'],
    'D#': ['D#','G','A#'],
    'E': ['E','G#','B'],
    'F': ['F','A','C'],
    'F#': ['F#','A#','C#'],
    'G': ['G','B','D'],
    'G#': ['G#','C','D#'],
    'A': ['A','C#','E'],
    'A#': ['A#','D','F'],
    'B': ['B','D#','F#']
  };

  function getRootFromChordLabel(label) {
    if (!label) return '';
    label = label.trim();
    if (!label) return '';
    let root = label[0].toUpperCase();
    if (label.length > 1 && (label[1] === '#' || label[1].toLowerCase() === 'b')) {
      root += label[1];
    }
    const flatMap = {'Bb':'A#','Db':'C#','Eb':'D#','Gb':'F#','Ab':'G#','Cb':'B','Fb':'E'};
    if (flatMap[root]) root = flatMap[root];
    return root;
  }

  // Ny förbättrad validering av ackord
  function isValidChord(token) {
    const root = getRootFromChordLabel(token);
    if (!root || token.length > 4 || !/^[A-G][#b]?(maj|min|dim|aug|[0-9]*)?$/.test(token)) {
        return false; // Avvisar ogiltiga ackord som "AAAA"
    }
    return !!rootToTriad[root];
  }

  function normalizeChordToken(token) {
    if (!token) return '';
    token = token.trim();
    token = token.replace(/♭/g,'b').replace(/♯/g,'#');
    let root = token[0].toUpperCase();
    if (token.length > 1 && (token[1] === '#' || token[1].toLowerCase() === 'b')) root += token[1];
    const flatMap = {'Bb':'A#','Db':'C#','Eb':'D#','Gb':'F#','Ab':'G#','Cb':'B','Fb':'E'};
    if (flatMap[root]) root = flatMap[root];
    return root + token.slice(root.length);
  }

  // Parser för R2A
  function loadFromR2A() {
    const text = document.getElementById('r2a-text').value;
    const lines = text.split(/\r?\n/);
    const r1Values = Array(R1_ROWS).fill('');
    let idx = 0;

    for (let i = 0; i < lines.length && idx < R1_ROWS; i++) {
      const tokens = lines[i].split(/\s+/);
      for (let t of tokens) {
        if (idx >= R1_ROWS) break;
        const norm = normalizeChordToken(t);
        if (!norm || !isValidChord(norm)) continue; // Endast giltiga ackord läggs till
        r1Values[idx++] = norm;
      }
    }
    setR1Values(r1Values); 
    updateR3FromR1();
  }
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R2A - Batch Chord Input Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #1a1a1a;
            color: #ffffff;
            padding: 0;
            margin: 0;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        #r2a-panel {
            width: 100%;
            background-color: #2b2b2b;
            border: 1px solid #444;
            padding: 12px;
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
        }

        .r2a-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .r2a-header h2 {
            font-size: 1.3rem;
            font-weight: bold;
            color: #ffffff;
        }

        .r2a-timestamp {
            font-size: 0.8rem;
            color: #888;
        }

        .r2a-help-text {
            font-size: 0.85rem;
            color: #ddd;
            margin-bottom: 15px;
            line-height: 1.4;
        }

        .r2a-main-container {
            margin-bottom: 12px;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .r2a-main-textarea {
            width: 100%;
            flex: 1;
            padding: 12px;
            border: 1px solid #555;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.95rem;
            line-height: 1.6;
            background-color: #ffffff;
            color: #000;
            resize: none;
            transition: border-color 0.2s;
            min-height: 0;
        }

        .r2a-main-textarea:focus {
            outline: none;
            border-color: #8fd694;
            box-shadow: 0 0 4px rgba(143, 214, 148, 0.3);
        }

        .r2a-global-buttons {
            display: flex;
            justify-content: flex-start;
            gap: 10px;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #444;
        }

        .r2a-btn-global {
            padding: 8px 16px;
            border: 2px solid;
            border-radius: 4px;
            font-size: 0.9rem;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.2s;
            min-width: 100px;
        }

        .r2a-btn-global:hover {
            opacity: 0.8;
        }

        .r2a-btn-global:active {
            opacity: 0.6;
        }

        .r2a-btn-load-all {
            background-color: transparent;
            border-color: #8fd694;
            color: #8fd694;
        }

        .r2a-btn-clear-all {
            background-color: #f4a6a6;
            border-color: #f4a6a6;
            color: black;
        }

        .r2a-footer {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #444;
            font-size: 0.7rem;
            color: #666;
            text-align: center;
        }
    </style>
</head>
<body>

<section id="r2a-panel">
    <div class="r2a-global-buttons">
        <button class="r2a-btn-global r2a-btn-load-all" id="r2a-b5" aria-label="Load All">B5 LR1 (All)</button>
        <button class="r2a-btn-global r2a-btn-clear-all" id="r2a-b6" aria-label="Clear All">B6 XR2A</button>
    </div>

    <div class="r2a-main-container">
        <textarea 
            class="r2a-main-textarea" 
            id="r2a-main-textarea"
            placeholder="Example:
C G Am F
Twinkle twinkle little star
Dm G C Am
How I wonder what you are"
            rows="20"
        ></textarea>
    </div>

    <div class="r2a-footer">
        R2A → R1 → R3 (pianogroups) → R2B (analysis)
    </div>
</section>

<script>
    // ===== R2A INITIALIZATION =====

    function initR2A() {
        attachGlobalListeners();
        loadFromStorage();
        updateTimestamp();
    }

    // ===== EVENT LISTENERS =====
    
    function attachGlobalListeners() {
        const textarea = document.getElementById('r2a-main-textarea');
        
        // Auto-save on blur
        textarea.addEventListener('blur', saveToStorage);
        
        // Global buttons
        document.getElementById('r2a-b5').addEventListener('click', handleB5Click);
        document.getElementById('r2a-b6').addEventListener('click', handleB6Click);
    }

    // ===== CHORD PARSING & VALIDATION =====
    
    function parseAllChords() {
        const textarea = document.getElementById('r2a-main-textarea');
        const lines = textarea.value.split('\n');
        const allChords = [];
        
        // Extract odd lines (0-indexed: 0, 2, 4... = lines 1, 3, 5...)
        lines.forEach((line, index) => {
            if (index % 2 === 0) { // Odd line number (1st, 3rd, 5th...)
                const chords = line
                    .trim()
                    .split(/\s+/)
                    .map(validateChord)
                    .filter(c => c !== null);
                allChords.push(...chords);
            }
            // Even lines (index % 2 === 1) are lyrics - ignored
        });
        
        return allChords;
    }

    const CHORD_REGEX = /^(?=.{1,10}$)[A-GH](?:#|b)?(?:maj|m|dim|aug|sus)?(?:2|4|5|6|7|9|11|13)?(?:(?:#|b)(?:5|9|11|13))?(?:add(?:9|11|13))?(?:\/[A-GH](?:#|b)?)?$/i;

    function validateChord(chord) {
        const trimmed = chord.trim();
        if (!trimmed) return null;
        if (!CHORD_REGEX.test(trimmed)) return null;
        
        // Check for duplicate add/extension
        const match = trimmed.match(/(\d+).*add(\d+)/i);
        if (match && match[1] === match[2]) return null;
        
        // Normalize H→B (including slash bass)
        return trimmed.replace(/^H/i, 'B').replace(/\/(H)/i, '/B');
    }

    // ===== R1 COMMUNICATION (via parent frame) =====
    
    function sendToR1(chords) {
        // Send to parent frame, which will route to R1
        window.parent.postMessage({
            type: 'R2A_LOAD_CHORDS',
            chords: chords
        }, '*');
        console.log('R2A: Sent chords via parent:', chords);
    }

    // ===== B5: LOAD ALL =====
    
    function handleB5Click() {
        const allChords = parseAllChords();
        
        if (allChords.length === 0) {
            console.log('R2A: No valid chords found');
            return;
        }

        console.log('R2A: Loading chords to R1:', allChords);
        sendToR1(allChords);
    }

    // ===== B6: CLEAR ALL (R2A ONLY) =====
    
    function handleB6Click() {
        const textarea = document.getElementById('r2a-main-textarea');
        if (textarea) {
            textarea.value = '';
            saveToStorage();
        }
    }

    // ===== STORAGE (PERSISTENCE) =====
    
    function saveToStorage() {
        const textarea = document.getElementById('r2a-main-textarea');
        if (textarea) {
            localStorage.setItem('r2a-data', textarea.value);
        }
    }

    function loadFromStorage() {
        const stored = localStorage.getItem('r2a-data');
        if (!stored) return;

        const textarea = document.getElementById('r2a-main-textarea');
        if (!textarea) return;

        // Check if it's old JSON format (migrate from old multi-row version)
        if (stored.startsWith('{')) {
            try {
                const oldData = JSON.parse(stored);
                // Convert old format to new format (extract chord lines only)
                const lines = [];
                for (let i = 1; i <= 10; i++) {
                    const rowData = oldData[`row-${i}`];
                    if (rowData && rowData.trim()) {
                        lines.push(rowData.trim());
                    }
                }
                textarea.value = lines.join('\n');
                // Save in new format
                saveToStorage();
            } catch (e) {
                console.warn('R2A: Failed to migrate old data', e);
                localStorage.removeItem('r2a-data');
            }
        } else {
            // New format - plain text
            textarea.value = stored;
        }
    }

    // ===== TIMESTAMP =====
    
    function updateTimestamp() {
        const now = new Date();
        const yy = String(now.getFullYear()).slice(-2);
        const mm = String(now.getMonth() + 1).padStart(2, '0');
        const dd = String(now.getDate()).padStart(2, '0');
        const hh = String(now.getHours()).padStart(2, '0');
        const mins = String(now.getMinutes()).padStart(2, '0');
        
        document.getElementById('r2a-timestamp').textContent = `${yy}.${mm}.${dd} • ${hh}.${mins}`;
    }

    // ===== INITIALIZATION =====
    
    document.addEventListener('DOMContentLoaded', initR2A);
</script>

</body>
</html>

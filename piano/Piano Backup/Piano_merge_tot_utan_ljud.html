<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <title>Piano Merge Layout – Ackordvalidering</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { background: #1e1e1e; color: #fff; font-family: Arial, Helvetica, sans-serif; margin: 0; padding: 0; height: 100vh; }
    .header, .divider { width: 100%; border-top: 2px solid #444; margin: 0; }
    .header-text { text-align: center; font-size: 1.1rem; font-weight: bold; background: #333; padding: 10px 0; letter-spacing: 2px; }
    .layout { display: grid; grid-template-columns: 15% 85%; height: calc(100vh - 80px); background: #2b2b2b; }
    .sidebar { border-right: 2px solid #444; padding: 10px; display: flex; flex-direction: column; gap: 10px; background: #2b2b2b; height: 100%; }
    .sidebar-title { font-size: 1.1rem; font-weight: bold; text-align: center; margin-bottom: 10px; }
    .main { display: flex; flex-direction: column; height: 100%; }
    .r2-area { display: flex; height: 30%; border-bottom: 2px solid #444; background: #2b2b2b; }
    .r2a, .r2b { padding: 10px; height: 100%; }
    .r2a { width: 40%; border-right: 2px solid #444; background: #2b2b2b; }
    .r2b { width: 45%; background: #2b2b2b; }
    .r3-area { height: 70%; background: #fff; padding: 10px; position: relative; }
    .r3-title { font-size: 1.1rem; font-weight: bold; color: #333; margin-bottom: 10px; }
    .piano-groups { display: flex; width: 100%; height: 60%; gap: 0; }
    .piano-group { flex: 1 1 0; background: #2b2b2b; border: 1px solid #444; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; margin: 0; padding-top: 5px; position: relative; }
    .chord-label { font-size: 0.75rem; color: #0078d4; text-align: center; margin-bottom: 2px; min-height: 1.2em; }
    .piano-keys { display: flex; width: 90%; height: 80px; position: relative; margin: 0 auto; }
    .white-key, .black-key { position: relative; border: 1px solid #333; box-sizing: border-box; display: flex; align-items: flex-end; justify-content: center; font-size: 0.75rem; font-family: monospace; }
    .white-key { width: 24px; height: 80px; background: #fdfdfd; color: #333; z-index: 1; }
    .black-key { width: 16px; height: 50px; background: #000; color: #fff; position: absolute; top: 0; z-index: 2; border-radius: 0 0 4px 4px; }
    .r3-buttons { display: flex; justify-content: center; gap: 12px; margin-top: 5px; }
    .r3-btn { width: 32px; height: 32px; border-radius: 50%; background: #0078d4; color: #fff; border: none; font-size: 0.9rem; cursor: pointer; transition: background 0.2s; }
    .r3-btn:hover { background: #00a86b; }
    input[type="text"], textarea { padding: 4px; border: 1px solid #555; border-radius: 4px; width: 100%; font-family: monospace; font-size: 0.9rem; margin-bottom: 4px; background: #fff; color: #222; }
    textarea { resize: vertical; min-height: 60px; line-height: 1.3; }
    .panel-btn { padding: 4px 8px; border-radius: 4px; background: #0078d4; color: #fff; border: none; margin-right: 5px; cursor: pointer; font-size: 0.9rem; transition: background 0.2s; }
    .panel-btn:hover { background: #00a86b; }
    .help-text { font-size: 0.8rem; color: #ddd; margin-top: 8px; line-height: 1.3; }
    .panel-btn, .r3-btn { outline: none; }
    .panel-btn:focus, .r3-btn:focus { box-shadow: 0 0 0 2px #4da3ff; }
  </style>
</head>
<body>
  <div class="header"></div>
  <div class="header-text">HEADER</div>
  <div class="header"></div>
  <div class="layout">
    <!-- Sidebar R1 -->
    <div class="sidebar">
      <div class="sidebar-title">R1</div>
      <form id="r1-form" autocomplete="off">
        <!-- 10 rows för ackordinmatning -->
      </form>
      <!-- Globala knappar -->
      <div>
        <button type="button" class="panel-btn" id="b3">LR3 (Load All)</button>
        <button type="button" class="panel-btn" id="b4">XR1 (Reset All)</button>
      </div>
      <div class="help-text">
        Input for chords start with caption characters<br>
        Tidsstämpel: <span id="timestamp"></span>
      </div>
    </div>
    <!-- Main Area -->
    <div class="main">
      <!-- R2 Area -->
      <div class="r2-area">
        <!-- R2A -->
        <div class="r2a">
          <div class="sidebar-title">R2A</div>
          <textarea id="r2a-text" placeholder="Skriv ackord och beskrivningar här..."></textarea>
          <div>
            <button type="button" class="panel-btn" id="b5">L</button>
            <button type="button" class="panel-btn" id="b6">X</button>
          </div>
        </div>
        <!-- R2B -->
        <div class="r2b">
          <div class="sidebar-title">R2B</div>
          <!-- Här kan du lägga till analys och pianografik -->
        </div>
      </div>
      <!-- R3 Area -->
      <div class="r3-area">
        <div class="r3-title">R3</div>
        <div class="piano-groups" id="r3-piano-groups">
          <!-- 10 piano groups -->
        </div>
        <div class="r3-buttons">
          <button type="button" class="r3-btn" title="Triad">B7</button>
          <button type="button" class="r3-btn" title="Tetrad">B8</button>
          <button type="button" class="r3-btn" title="Inversion">B9</button>
          <button type="button" class="r3-btn" title="Load to R2B">BR3</button>
        </div>
      </div>
    </div>
  </div>
  <script>
    // Tidsstämpel
    function pad(n) { return n < 10 ? '0' + n : n; }
    const now = new Date();
    const timestamp = `${now.getFullYear().toString().slice(2)}.${pad(now.getMonth()+1)}.${pad(now.getDate())} ${pad(now.getHours())}.${pad(now.getMinutes())}`;
    document.getElementById('timestamp').textContent = timestamp;

    // Ackordvalidering enligt reglerna
    function isValidChord(chord) {
      if (!chord) return false;
      if (chord.length > 10) return false;
      // Rot: A-G
      let regex = /^([A-G])([#b]?)(maj|min|dim|aug|sus|dom)?(2|4|5|6|7|9|11|13)?((#5|b5|#9|b9|#11|b13)?)((add9|add11|add13)?)$/;
      return regex.test(chord);
    }

    // Skapa R1-formuläret dynamiskt
    const r1Form = document.getElementById('r1-form');
    for (let i = 0; i < 10; i++) {
      const row = document.createElement('div');
      row.style.display = 'flex';
      row.style.alignItems = 'center';
      row.style.marginBottom = '4px';

      const input = document.createElement('input');
      input.type = 'text';
      input.maxLength = 10;
      input.placeholder = 'Ackord (t.ex. Cmaj7)';
      input.autocomplete = 'off';

      const b1 = document.createElement('button');
      b1.type = 'button';
      b1.className = 'panel-btn';
      b1.textContent = 'LR3';

      const b2 = document.createElement('button');
      b2.type = 'button';
      b2.className = 'panel-btn';
      b2.textContent = 'XR1';

      // B1: Ladda till R3, spela ljud om giltigt
      b1.addEventListener('click', () => {
        if (isValidChord(input.value.trim())) {
          updateR3Chord(i, input.value.trim());
          playChord(input.value.trim());
        } else {
          input.value = '';
          updateR3Chord(i, '');
        }
      });

      // B2: Rensa aktuell rad och R3
      b2.addEventListener('click', () => {
        input.value = '';
        updateR3Chord(i, '');
      });

      row.appendChild(input);
      row.appendChild(b1);
      row.appendChild(b2);
      r1Form.appendChild(row);
    }

    // R3: 10 pianogrupper
    const r3PianoGroups = document.getElementById('r3-piano-groups');
    function createPianoGroup(label = '') {
      const group = document.createElement('div');
      group.className = 'piano-group';
      const chordLabel = document.createElement('div');
      chordLabel.className = 'chord-label';
      chordLabel.textContent = label;
      group.appendChild(chordLabel);

      // Enkel pianografik (endast vita tangenter, för demo)
      const pianoKeys = document.createElement('div');
      pianoKeys.className = 'piano-keys';
      for (let i = 0; i < 7; i++) {
        const whiteKey = document.createElement('div');
        whiteKey.className = 'white-key';
        whiteKey.textContent = ['C','D','E','F','G','A','B'][i];
        pianoKeys.appendChild(whiteKey);
      }
      group.appendChild(pianoKeys);
      return group;
    }

    // Initiera R3
    function initR3() {
      r3PianoGroups.innerHTML = '';
      for (let i = 0; i < 10; i++) {
        r3PianoGroups.appendChild(createPianoGroup(''));
      }
    }
    initR3();

    // Uppdatera ett ackord i R3
    function updateR3Chord(index, chord) {
      const group = r3PianoGroups.children[index];
      if (group) {
        group.querySelector('.chord-label').textContent = chord;
      }
    }

    // B3: Load All – ladda alla giltiga ackord till R3, spela ljud för alla
    document.getElementById('b3').addEventListener('click', () => {
      const inputs = r1Form.querySelectorAll('input[type="text"]');
      let played = false;
      for (let i = 0; i < 10; i++) {
        const val = inputs[i].value.trim();
        if (isValidChord(val)) {
          updateR3Chord(i, val);
          playChord(val, true);
          played = true;
        } else {
          inputs[i].value = '';
          updateR3Chord(i, '');
        }
      }
      if (played) playChord('Alla ackord');
    });

    // B4: Reset All – rensa alla R1 och R3
    document.getElementById('b4').addEventListener('click', () => {
      const inputs = r1Form.querySelectorAll('input[type="text"]');
      for (let i = 0; i < 10; i++) {
        inputs[i].value = '';
        updateR3Chord(i, '');
      }
    });

    // R2A: Ladda udda rader till R1 (giltiga ackord)
    document.getElementById('b5').addEventListener('click', () => {
      const lines = document.getElementById('r2a-text').value.split('\n');
      const inputs = r1Form.querySelectorAll('input[type="text"]');
      let r1Index = 0;
      for (let i = 0; i < lines.length && r1Index < 10; i += 2) {
        const chord = lines[i].trim();
        if (isValidChord(chord)) {
          inputs[r1Index].value = chord;
        } else {
          inputs[r1Index].value = '';
        }
        r1Index++;
      }
      // Fyll resterande rader med tomma strängar
      for (; r1Index < 10; r1Index++) {
        inputs[r1Index].value = '';
      }
    });

    // R2A: Reset
    document.getElementById('b6').addEventListener('click', () => {
      document.getElementById('r2a-text').value = '';
    });

    // Ljuduppspelning (simulerad)
    function playChord(chord, silent) {
      if (silent) return; // Vid Load All, spela inte varje ackord individuellt
      // Ersätt med Web Audio API för riktig ljuduppspelning
      alert('Spelar ackord: ' + chord);
    }
  </script>
</body>
</html>
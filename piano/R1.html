<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R1 - Chord Input & Validation Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #1a1a1a;
            color: #ffffff;
            padding: 0;
            margin: 0;
            display: flex;
            gap: 0;
            overflow-x: hidden;
            height: 100%;
        }

        #r1-panel {
            width: 100%;
            background-color: #2b2b2b;
            border: 1px solid #444;
            padding: 12px;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow-y: auto;
        }

        .r1-header {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .r1-header h2 {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .r1-timestamp {
            font-size: 0.75rem;
            color: #888;
        }

        .r1-help-text {
            font-size: 0.85rem;
            color: #ddd;
            margin-bottom: 12px;
            line-height: 1.3;
        }

        .r1-rows-container {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-bottom: 10px;
            align-items: center;
        }

        .r1-row {
            display: flex;
            gap: 3px;
            align-items: center;
        }

        .r1-row-number {
            font-size: 0.7rem;
            color: #888;
            min-width: 20px;
            text-align: right;
            font-weight: bold;
        }

        .r1-textform {
            flex: 1;
            padding: 6px 8px;
            border: 1px solid #555;
            border-radius: 4px;
            font-family: Arial, sans-serif;
            font-size: 0.9rem;
            background-color: #ffffff;
            color: #000;
            width: 8ch;
            max-width: 8ch;
            transition: border-color 0.2s;
        }

        .r1-textform:focus {
            outline: none;
            border-color: #8fd694;
        }

        .r1-textform:invalid {
            border-color: #555;
        }

        .r1-btn-row {
            display: flex;
            gap: 2px;
        }

        .r1-btn {
            width: 26px;
            height: 26px;
            padding: 0;
            border: none;
            border-radius: 3px;
            font-size: 0.75rem;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .r1-btn:hover {
            opacity: 0.8;
        }

        .r1-btn:active {
            opacity: 0.6;
        }

        .r1-btn-load {
            background-color: #8fd694;
            color: white;
        }

        .r1-btn-clear {
            background-color: #f4a6a6;
            color: white;
        }

        .r1-global-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #444;
        }

        .r1-btn-compact {
            width: 55px;
        }

        .r1-btn-global {
            padding: 8px 12px;
            border: 2px solid;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .r1-btn-global:hover {
            opacity: 0.8;
        }

        .r1-btn-global:active {
            opacity: 0.6;
        }

        .r1-btn-load-all {
            background-color: transparent;
            border-color: #8fd694;
            color: #8fd694;
        }

        .r1-btn-clear-all {
            background-color: #f4a6a6;
            border-color: #f4a6a6;
            color: white;
        }

        .r1-footer {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #444;
            font-size: 0.7rem;
            color: #666;
            text-align: center;
            line-height: 1.3;
        }

        #r3-placeholder {
            flex: 1;
            background-color: #2b2b2b;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 1.2rem;
        }
    </style>
</head>
<body>

<section id="r1-panel">
    <div class="r1-global-buttons">
        <button class="r1-btn-global r1-btn-load-all r1-btn-compact" id="r1-b3" aria-label="Load All to R3">LR3</button>
        <button class="r1-btn-global r1-btn-clear-all" id="r1-b4" aria-label="Clear All">XR1</button>
    </div>

    <div class="r1-rows-container" id="r1-rows-container">
        <!-- Rows generated here -->
    </div>

    <div class="r1-footer">
        R1: Validate → R3: Display<br>
        Shift+Enter = B3 (Load All)
    </div>
</section>

<script>
    // Register event listener FIRST, before any other code
    document.addEventListener('DOMContentLoaded', initR1);
    
    // ===== R1 CHORD VALIDATION =====
    
    const CHORD_REGEX = /^(?=.{1,10}$)[A-GH](?:#|b)?(?:maj|m|dim|aug|sus)?(?:2|4|5|6|7|9|11|13)?(?:(?:#|b)(?:5|9|11|13))?(?:add(?:9|11|13))?(?:\/[A-GH](?:#|b)?)?$/i;

    function validateChord(chord) {
        const trimmed = chord.trim();
        if (!trimmed) return null;
        if (!CHORD_REGEX.test(trimmed)) return null;
        
        // Check for duplicate add/extension
        const match = trimmed.match(/(\d+).*add(\d+)/i);
        if (match && match[1] === match[2]) return null;
        
        // Normalize H→B (including slash bass)
        return trimmed.replace(/^H/i, 'B').replace(/\/(H)/i, '/B');
    }

    // ===== AUDIO PLAYBACK =====
    
    let audioContext = null;
    
    function getAudioContext() {
        if (!audioContext) {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioContext = new AudioContext();
        }
        return audioContext;
    }

    function noteToFrequency(note) {
        // Parse note like "C4", "D#4", "Ab5" to frequency
        const noteMap = {
            'C': 0, 'D': 2, 'E': 4, 'F': 5, 'G': 7, 'A': 9, 'B': 11, 'H': 11
        };
        
        const match = note.match(/^([A-GH])([#b]?)(\d)$/i);
        if (!match) return 440;
        
        let [, noteName, accidental, octave] = match;
        octave = parseInt(octave, 10);
        noteName = noteName.toUpperCase();
        
        let semitone = noteMap[noteName] || 0;
        if (accidental === '#') semitone += 1;
        if (accidental === 'b') semitone -= 1;
        
        const midiNote = (octave + 1) * 12 + semitone;
        return 440 * Math.pow(2, (midiNote - 69) / 12);
    }

    function playTone(frequency, duration = 0.3, gain = 0.1) {
        try {
            const ctx = getAudioContext();
            const osc = ctx.createOscillator();
            const gainNode = ctx.createGain();
            
            osc.type = 'sine';
            osc.frequency.value = frequency;
            
            gainNode.gain.setValueAtTime(gain, ctx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + duration);
            
            osc.connect(gainNode);
            gainNode.connect(ctx.destination);
            
            osc.start(ctx.currentTime);
            osc.stop(ctx.currentTime + duration);
        } catch (e) {
            console.warn('Audio not available:', e.message);
        }
    }

    function playChordSound() {
        // No-op: R3 handles audio playback
    }

    // ===== R1 INITIALIZATION =====
    
    function initR1() {
        alert('R1 initializing...');
        console.log('initR1 starting');
        generateRows();
        console.log('Rows generated');
        const btns = document.querySelectorAll('.r1-btn-row');
        console.log('Found .r1-btn-row elements:', btns.length);
        attachRowListeners();
        console.log('Row listeners attached');
        attachGlobalListeners();
    }

    // ===== ROW GENERATION =====
    
    function generateRows() {
        const container = document.getElementById('r1-rows-container');
        for (let i = 1; i <= 24; i++) {
            const row = document.createElement('div');
            row.className = 'r1-row';
            row.innerHTML = `
                <span class="r1-row-number">${i}</span>
                <input 
                    type="text" 
                    class="r1-textform" 
                    id="r1-textform-${i}"
                    placeholder="Ex: Cmaj7"
                    maxlength="10"
                    aria-label="Row ${i}"
                />
                <div class="r1-btn-row">
                    <button class="r1-btn r1-btn-load" data-row="${i}" data-action="load" aria-label="Load Row ${i} to R3">L</button>
                    <button class="r1-btn r1-btn-clear" data-row="${i}" data-action="clear" aria-label="Clear Row ${i}">X</button>
                </div>
            `;
            container.appendChild(row);
        }
    }

    // ===== EVENT LISTENERS =====
    
    function attachRowListeners() {
        document.querySelectorAll('.r1-btn-row').forEach(container => {
            container.addEventListener('click', (e) => {
                console.log('Click on container, target:', e.target.tagName, 'classes:', e.target.className);
                if (!e.target.classList.contains('r1-btn')) {
                    console.log('Target not r1-btn, skipping');
                    return;
                }
                
                const rowIndex = parseInt(e.target.dataset.row);
                const action = e.target.dataset.action;
                
                console.log('B1/B2 Handler - action:', action, 'rowIndex:', rowIndex);
                
                if (action === 'load') {
                    handleB1Click(rowIndex);
                } else if (action === 'clear') {
                    handleB2Click(rowIndex);
                }
            });
        });

        // Validate on blur
        document.querySelectorAll('.r1-textform').forEach(input => {
            input.addEventListener('blur', (e) => {
                const chord = e.target.value.trim();
                if (chord && !validateChord(chord)) {
                    e.target.value = ''; // Clear invalid chords silently
                }
            });
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && e.shiftKey) {
                handleB3Click();
            }
        });
    }

    function attachGlobalListeners() {
        document.getElementById('r1-b3').addEventListener('click', handleB3Click);
        document.getElementById('r1-b4').addEventListener('click', handleB4Click);
    }

    // ===== B1: LOAD ROW TO R3 =====
    
    window.handleB1Click = function(rowIndex) {
        console.log('B1 clicked, rowIndex:', rowIndex);
        const input = document.getElementById(`r1-textform-${rowIndex}`);
        if (!input) {
            console.warn('Input not found:', rowIndex);
            return;
        }

        const chord = input.value.trim();
        console.log('Chord value:', chord);
        
        if (!chord) {
            console.log('Empty chord, skipping');
            return;
        }
        
        const validated = validateChord(chord);
        console.log('Validated chord:', validated);
        if (!validated) {
            input.value = '';
            return;
        }
        
        // Send to R3 via postMessage
        window.parent.postMessage({
            type: 'R1_LOAD_CHORD',
            chord: validated,
            rowIndex: rowIndex
        }, '*');
        console.log('[R1] Sent to R3 via postMessage:', { chord: validated, rowIndex });
        
        // Log to R2A parse log for debugging
        const logEntry = {
            ts: new Date().toISOString(),
            source: 'R1',
            chord: validated,
            rowIndex: rowIndex,
            action: 'sent_to_R3'
        };
        const parseLog = JSON.parse(localStorage.getItem('r2a-parse-log') || '[]');
        parseLog.push(logEntry);
        localStorage.setItem('r2a-parse-log', JSON.stringify(parseLog));
        
        // No sound here (R3 handles audio)
    };

    // ===== B2: CLEAR ROW =====
    
    function handleB2Click(rowIndex) {
        const input = document.getElementById(`r1-textform-${rowIndex}`);
        if (input) input.value = '';
        
        // Send clear message to R3 via postMessage
        window.parent.postMessage({
            type: 'R1_CLEAR_ROW',
            rowIndex: rowIndex
        }, '*');
        console.log('[R1] Sent clear to R3 via postMessage:', rowIndex);
        
        // No sound
    }

    // ===== B3: LOAD ALL TO R3 =====
    
    function handleB3Click() {
        // Collect all 24 chords
        const chordArray = [];
        const r1Inputs = document.querySelectorAll('.r1-textform');
        
        r1Inputs.forEach((input) => {
            const chord = input.value.trim();
            
            if (!chord) {
                chordArray.push(""); // Empty string for cleared/blank rows
                return;
            }
            
            const validated = validateChord(chord);
            if (!validated) {
                input.value = ''; // Clear invalid chords
                chordArray.push("");
                return;
            }
            
            chordArray.push(validated); // Add valid chord to array
        });
        
        // Send entire batch to R3 via postMessage
        window.parent.postMessage({
            type: 'R1_LOAD_ALL',
            chords: chordArray
        }, '*');
        console.log('[R1] B3 sent all chords to R3 via postMessage');
    }

    // ===== B4: CLEAR ALL =====
    
    function handleB4Click() {
        const r1Inputs = document.querySelectorAll('.r1-textform');
        
        // Clear all inputs
        r1Inputs.forEach((input) => {
            input.value = '';
        });
        
        // Send clear all message to R3 via postMessage
        window.parent.postMessage({
            type: 'R1_CLEAR_ALL'
        }, '*');
        console.log('[R1] B4 sent clear all to R3 via postMessage');
        
        // No sound
    }

    // ===== TIMESTAMP =====
    
    function updateTimestamp() {
        const now = new Date();
        const yy = String(now.getFullYear()).slice(-2);
        const mm = String(now.getMonth() + 1).padStart(2, '0');
        const dd = String(now.getDate()).padStart(2, '0');
        const hh = String(now.getHours()).padStart(2, '0');
        const mins = String(now.getMinutes()).padStart(2, '0');
        
        document.getElementById('r1-timestamp').textContent = `${yy}.${mm}.${dd} • ${hh}.${mins}`;
    }

    // ===== IFRAME COMMUNICATION =====
    
    window.addEventListener('message', (event) => {
        if (event.data.type === 'R2A_LOAD_CHORDS') {
            const chords = event.data.chords;
            console.log('R1: Received chords from R2A:', chords);
            
            // Reset all rows
            for (let i = 1; i <= 24; i++) {
                const input = document.getElementById(`r1-textform-${i}`);
                if (input) input.value = '';
            }
            
            // Fill with new chords
            const clamped = chords.slice(0, 24);
            clamped.forEach((chord, index) => {
                const input = document.getElementById(`r1-textform-${index + 1}`);
                if (input) input.value = chord;
            });
            
            // Trigger B1 handlers with delay
            let soundDelay = 0;
            for (let i = 1; i <= Math.min(chords.length, 24); i++) {
                setTimeout(() => {
                    handleB1Click(i);
                }, soundDelay);
                soundDelay += 400;
            }
        }
    });

    // ===== INITIALIZATION =====
    
    function initR1() {
        alert('R1 initializing...');
        console.log('initR1 starting');
        generateRows();
        console.log('Rows generated');
        const btns = document.querySelectorAll('.r1-btn-row');
        console.log('Found .r1-btn-row elements:', btns.length);
        attachRowListeners();
        console.log('Row listeners attached');
        attachGlobalListeners();
    }
</script>

</body>
</html>

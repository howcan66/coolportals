<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piano Chords & Lyrics - Analyse & View</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #1a1a1a;
            color: #fff;
            padding: 10px;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        .frame-header {
            background-color: #0d47a1;
            padding: 4px 8px; /* compact top row */
            border-radius: 3px;
            margin-bottom: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .frame-header h1 {
            font-size: 0.85rem; /* reduced font size */
            font-weight: bold;
            line-height: 1; /* prevent tall header */
        }

        .frame-header .data-flow {
            display: flex;
            align-items: center;
            gap: 8px; /* suitable distance between items */
            font-size: 0.7rem; /* compact size */
            color: #b3e5fc;
            line-height: 1; /* tight row */
        }

        .frame-header .workflow-steps {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            font-size: 0.68rem; /* compact */
            color: #e3f2fd;
            line-height: 1; /* tight row */
        }

        .frame-container {
            display: grid;
            grid-template-columns: 0.125fr 0.33fr 6px 0.545fr;
            grid-template-rows: var(--row1-height, 0.3fr) 8px var(--row2-height, 0.7fr);
            grid-template-areas:
                "r1 r2a h-divider r2b"
                "r1 divider divider divider"
                "r1 r3 r3 r3";
            gap: 6px;
            flex: 1;
            min-height: 0;
            position: relative;
        }

        .h-resize-divider {
            grid-area: h-divider;
            background: transparent;
            cursor: ew-resize;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
        }

        .h-resize-divider::before {
            content: '';
            width: 4px;
            height: 100%;
            background: #0d47a1;
            border-radius: 2px;
            transition: background 0.2s, width 0.2s;
        }

        .h-resize-divider:hover::before {
            background: #4dd0e1;
            width: 6px;
        }

        .h-resize-divider.dragging::before {
            background: #4dd0e1;
            width: 6px;
        }

        .resize-divider {
            grid-area: divider;
            background: transparent;
            cursor: ns-resize;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
        }

        .resize-divider::before {
            content: '';
            width: 100%;
            height: 4px;
            background: #0d47a1;
            border-radius: 2px;
            transition: background 0.2s, height 0.2s;
        }

        .resize-divider:hover::before {
            background: #4dd0e1;
            height: 6px;
        }

        .resize-divider.dragging::before {
            background: #4dd0e1;
            height: 6px;
        }

        .frame-r1 { grid-area: r1; }
        .frame-r2a { grid-area: r2a; }
        .frame-r2b { grid-area: r2b; }
        .frame-r3 { grid-area: r3; }
        
        .frame-r3 iframe {
            overflow-y: auto;
        }

        .frame-wrapper {
            display: flex;
            flex-direction: column;
            background-color: #2a2a2a;
            border-radius: 2px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.4);
            overflow: hidden;
        }

        .frame-r1 {
            overflow: auto;
        }

        .frame-r1 iframe {
            min-width: 260px;
        }

        iframe {
            flex: 1;
            border: none;
            background-color: #fff;
            min-height: 0;
        }

        .frame-nav-buttons {
            display: flex;
            gap: 6px;
            justify-content: flex-end;
            align-items: center;
            margin-top: 4px;
        }

        .frame-nav-btn {
            width: 44px;
            height: 36px;
            padding: 0;
            border: 1px solid #4fc3f7;
            border-radius: 3px;
            background-color: transparent;
            color: #4fc3f7;
            cursor: pointer;
            font-weight: bold;
            font-size: 18px;
            transition: all 0.2s;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .frame-nav-btn i {
            font-size: 1.2rem;
        }

        .frame-nav-btn:hover::after {
            content: attr(title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #0d47a1;
            color: #fff;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 1000;
            pointer-events: none;
            border: 1px solid #4fc3f7;
            margin-bottom: 4px;
        }

        .frame-nav-btn:hover {
            background-color: #4fc3f7;
            color: #0d47a1;
        }

        .frame-nav-btn.active {
            background-color: #4fc3f7;
            color: #0d47a1;
        }

        /* === MOBILE/TABLET FIX: Hide R2B on â‰¤1024px === */
        @media (max-width: 1024px) {
            .frame-header {
                padding: 4px;
            }
            
            .frame-header h1 {
                font-size: 0.75rem;
            }
            
            #frame-timestamp {
                display: none;  /* Hide timestamp on mobile */
            }
            
            .frame-nav-btn {
                width: 32px;
                height: 32px;
                font-size: 16px;
            }

            .frame-nav-btn i {
                font-size: 0.9rem;
            }
            
            .frame-nav-buttons {
                gap: 3px;  /* Tighter button spacing */
            }

            /* Hide R1, R2B and h-divider on tablet */
            .frame-r1,
            .frame-r2b,
            .h-resize-divider {
                display: none;
            }

            /* Adjust grid for tablet (R2A full width top, R3 full width bottom) */
            .frame-container {
                grid-template-columns: 1fr;
                grid-template-areas:
                    "r2a"
                    "divider"
                    "r3";
            }
        }
    </style>
</head>
<body>

<div class="frame-header">
    <div style="display: flex; justify-content: space-between; align-items: flex-end; width: 100%;">
        <h1 style="margin: 0; cursor: help;" title="R2A (input) â†’ R1 (validation) â†’ R3 (display) â†’ R2B (analysis)
R1 (single row input) â†’ R3 (display)">
            ðŸŽ¹ Piano Chords & Lyrics Analyse & View
            <span id="frame-version" style="font-size:0.72rem; color:#b3e5fc; margin-left:8px; display:inline-block;"></span>
            <span id="frame-timestamp" style="font-size:0.75rem; color:#888; margin-left:8px; display:inline-block;"></span>
        </h1>
        <div class="frame-nav-buttons" id="frame-nav-buttons">
            <button class="frame-nav-btn active" data-nav="0" title="Ultimate Guitar">
                <i class="fa-solid fa-music"></i>
            </button>
            <button class="frame-nav-btn" data-nav="1" title="Sample Data">
                <i class="fa-solid fa-music"></i>
            </button>
            <button class="frame-nav-btn" data-nav="2" title="Linear Layout">
                <i class="fa-solid fa-list-ol"></i>
            </button>
            <button class="frame-nav-btn" data-nav="3" title="Desktop Layout">
                <i class="fa-solid fa-desktop"></i>
            </button>
            <button class="frame-nav-btn" data-nav="4" title="Tablet Layout">
                <i class="fa-solid fa-tablet-screen-button"></i>
            </button>
            <button class="frame-nav-btn" data-nav="5" title="Mobile Layout">
                <i class="fa-solid fa-mobile-screen"></i>
            </button>
            <button class="frame-nav-btn" data-nav="6" title="Help">
                <i class="fa-solid fa-circle-question"></i>
            </button>
        </div>
    </div>
</div>

<div class="frame-container">
    <div class="frame-wrapper frame-r2a">
        <iframe id="r2a-frame" name="r2a-frame" src="R2A.html?v=2.0.0"></iframe>
    </div>

    <div class="h-resize-divider" id="h-resize-divider"></div>

    <div class="frame-wrapper frame-r2b">
        <iframe id="r2b-frame" name="r2b-frame" src="R2B.html?v=2.0.0"></iframe>
    </div>

    <div class="frame-wrapper frame-r1">
        <iframe id="r1-frame" name="r1-frame" src="R1.html?v=2.0.0"></iframe>
    </div>

    <div class="resize-divider" id="resize-divider"></div>

    <div class="frame-wrapper frame-r3">
        <iframe id="r3-frame" name="r3-frame" src="R3.html?v=2.0.0"></iframe>
    </div>
</div>

<script>
    const APP_VERSION = 'v2.0.0';
    // ===== RESIZE DIVIDER =====
    const divider = document.getElementById('resize-divider');
    const container = document.querySelector('.frame-container');
    let isDragging = false;

    // Load saved position
    function loadDividerPosition() {
        const saved = localStorage.getItem('frame-divider-position');
        if (saved) {
            const percentage = parseFloat(saved);
            document.documentElement.style.setProperty('--row1-height', percentage + 'fr');
            document.documentElement.style.setProperty('--row2-height', (1 - percentage) + 'fr');
        }
    }

    // Save position
    function saveDividerPosition(percentage) {
        localStorage.setItem('frame-divider-position', percentage);
    }

    loadDividerPosition();

    divider.addEventListener('mousedown', (e) => {
        isDragging = true;
        divider.classList.add('dragging');
        document.body.style.cursor = 'ns-resize';
        document.body.style.userSelect = 'none';
        
        // Disable pointer events on iframes to prevent interference
        document.querySelectorAll('iframe').forEach(iframe => {
            iframe.style.pointerEvents = 'none';
        });
        
        e.preventDefault();
    });

    document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        
        e.preventDefault(); // Prevent text selection during drag
        
        const containerRect = container.getBoundingClientRect();
        const mouseY = e.clientY - containerRect.top;
        const containerHeight = containerRect.height;
        
        // Calculate percentage position
        let percentage = mouseY / containerHeight;
        
        // Clamp between 5% and 95% (maximum flexibility)
        percentage = Math.max(0.05, Math.min(0.95, percentage));
        
        const row1 = percentage;
        const row2 = 1 - percentage;
        
        document.documentElement.style.setProperty('--row1-height', row1 + 'fr');
        document.documentElement.style.setProperty('--row2-height', row2 + 'fr');
    });

    document.addEventListener('mouseup', () => {
        if (isDragging) {
            isDragging = false;
            divider.classList.remove('dragging');
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
            
            // Save position
            const row1Value = getComputedStyle(document.documentElement).getPropertyValue('--row1-height');
            const percentage = parseFloat(row1Value);
            if (!isNaN(percentage)) {
                saveDividerPosition(percentage);
            }
            
            // Re-enable pointer events on iframes
            document.querySelectorAll('iframe').forEach(iframe => {
                iframe.style.pointerEvents = '';
            });
        }
    });

    // ===== HORIZONTAL RESIZE DIVIDER (R2A/R2B) =====
    const hDivider = document.getElementById('h-resize-divider');
    let isHDragging = false;
    let startR2aWidth = 0.33;
    let startR2bWidth = 0.545;

    hDivider.addEventListener('mousedown', (e) => {
        isHDragging = true;
        hDivider.classList.add('dragging');
        document.body.style.cursor = 'ew-resize';
        document.body.style.userSelect = 'none';
        
        document.querySelectorAll('iframe').forEach(iframe => {
            iframe.style.pointerEvents = 'none';
        });
        
        e.preventDefault();
    });

    document.addEventListener('mousemove', (e) => {
        if (!isHDragging) return;
        
        e.preventDefault();
        
        const containerRect = container.getBoundingClientRect();
        const mouseX = e.clientX - containerRect.left;
        const containerWidth = containerRect.width;
        
        // Account for R1 (12.5%) and gaps
        const r1Width = 0.125;
        const gap = 0.03; // approximate gap
        const availableWidth = containerWidth * (1 - r1Width - gap);
        
        // New R2A width relative to available space
        const newR2aWidth = mouseX / containerWidth - r1Width - gap;
        const newR2bWidth = 1 - r1Width - gap - newR2aWidth;
        
        // Clamp between 20% and 80%
        const clampedR2a = Math.max(0.2, Math.min(0.6, newR2aWidth));
        const clampedR2b = 1 - r1Width - gap - clampedR2a;
        
        container.style.gridTemplateColumns = `0.125fr ${clampedR2a}fr 6px ${clampedR2b}fr`;
    });

    document.addEventListener('mouseup', () => {
        if (isHDragging) {
            isHDragging = false;
            hDivider.classList.remove('dragging');
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
            
            document.querySelectorAll('iframe').forEach(iframe => {
                iframe.style.pointerEvents = '';
            });
        }
    });

    // ===== IFRAME MESSAGE ROUTING =====
    window.addEventListener('message', (event) => {
        // Route messages between iframes
        console.log('[Frame Router] Received message:', event.data.type);
        
        if (event.data.type === 'R2A_LOAD_CHORDS') {
            // Device-aware routing: R2A B5
            // Tablet (â‰¤1024px): Convert to R1_LOAD_ALL format, route to R3
            // Desktop (>1024px): Route to R1 as-is
            
            const isTablet = window.innerWidth <= 1024;
            
            if (isTablet) {
                // Convert R2A_LOAD_CHORDS to R1_LOAD_ALL format and send to R3
                const convertedMessage = {
                    type: 'R1_LOAD_ALL',
                    chords: event.data.chords
                    // titleLine discarded on tablet (no R1 to display it)
                };
                
                const r3Frame = document.getElementById('r3-frame');
                if (r3Frame && r3Frame.contentWindow) {
                    r3Frame.contentWindow.postMessage(convertedMessage, '*');
                    console.log('[Frame Router] R2Aâ†’R3 (tablet): converted R2A_LOAD_CHORDS to R1_LOAD_ALL, sent', event.data.chords.length, 'chords');
                }
            } else {
                // Route to R1 on desktop (user can manipulate)
                const r1Frame = document.getElementById('r1-frame');
                if (r1Frame && r1Frame.contentWindow) {
                    r1Frame.contentWindow.postMessage(event.data, '*');
                    console.log('[Frame Router] R2Aâ†’R1 (desktop): chords loaded');
                }
            }
        }
        else if (event.data.type === 'R1_LOAD_CHORD') {
            // Route R1â†’R3 (B1: Load single chord)
            const r3Frame = document.getElementById('r3-frame');
            if (r3Frame && r3Frame.contentWindow) {
                r3Frame.contentWindow.postMessage(event.data, '*');
                console.log('[Frame Router] R1â†’R3: chord loaded', event.data.chord);
            }
        }
        else if (event.data.type === 'R1_LOAD_ALL') {
            // Route R1â†’R3 (B3: Load all chords)
            const r3Frame = document.getElementById('r3-frame');
            if (r3Frame && r3Frame.contentWindow) {
                r3Frame.contentWindow.postMessage(event.data, '*');
                console.log('[Frame Router] R1â†’R3: all chords loaded');
            }
        }
        else if (event.data.type === 'R1_CLEAR_ALL') {
            // Route R1â†’R3 (B4: Clear all)
            const r3Frame = document.getElementById('r3-frame');
            if (r3Frame && r3Frame.contentWindow) {
                r3Frame.contentWindow.postMessage(event.data, '*');
                console.log('[Frame Router] R1â†’R3: cleared');
            }
        }
        else if (event.data.type === 'R3_SEND_TO_R2B') {
            // Route R3â†’R2B (BR3: Send chord analysis)
            const r2bFrame = document.getElementById('r2b-frame');
            if (r2bFrame && r2bFrame.contentWindow) {
                r2bFrame.contentWindow.postMessage(event.data, '*');
                console.log('[Frame Router] R3â†’R2B: chord sent for analysis');
            }
        }
        else if (event.data.type === 'R3_FOCUS_AND_PLAY') {
            // Route R1â†’R3 (B25: Focus row and play)
            const r3Frame = document.getElementById('r3-frame');
            if (r3Frame && r3Frame.contentWindow) {
                r3Frame.contentWindow.postMessage(event.data, '*');
                console.log('[Frame Router] R1â†’R3: focus and play', event.data.rowIndex);
            }
        }
        else if (event.data.type === 'LOAD_CHORD_DATA') {
            // Route Sample.htmlâ†’R2A (Load chord data into R2A)
            const r2aFrame = document.getElementById('r2a-frame');
            if (r2aFrame && r2aFrame.contentWindow) {
                r2aFrame.contentWindow.postMessage(event.data, '*');
                console.log('[Frame Router] Sampleâ†’R2A: chord data loaded');
            }
        }
        else if (event.data.type === 'SET_CHORD_DURATION') {
            // Route R2Bâ†’R3 (Set chord duration)
            const r3Frame = document.getElementById('r3-frame');
            if (r3Frame && r3Frame.contentWindow) {
                r3Frame.contentWindow.postMessage(event.data, '*');
                console.log('[Frame Router] R2Bâ†’R3: duration set to', event.data.duration);
            }
        }
        else if (event.data.type === 'EDIT_SAMPLE') {
            // Route R2Aâ†’Sample (Edit existing sample)
            const sampleFrame = document.getElementById('sample-frame');
            if (sampleFrame && sampleFrame.contentWindow) {
                sampleFrame.contentWindow.postMessage(event.data, '*');
                console.log('[Frame Router] R2Aâ†’Sample: Edit mode with data:', event.data.data);
            }
        }
    });

    // ===== TIMESTAMP =====
    function updateFrameTimestamp() {
        const d = new Date();
        const yy = String(d.getFullYear()).slice(-2);
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const dd = String(d.getDate()).padStart(2,'0');
        const hh = String(d.getHours()).padStart(2,'0');
        const mi = String(d.getMinutes()).padStart(2,'0');
        const tsEl = document.getElementById('frame-timestamp');
        if (tsEl) tsEl.textContent = `${yy}.${mm}.${dd} â€¢ ${hh}.${mi}`;
    }
    
    const versionEl = document.getElementById('frame-version');
    if (versionEl) versionEl.textContent = APP_VERSION;

    // ===== NAVIGATION BUTTONS =====
    const navButtons = document.querySelectorAll('.frame-nav-btn');
    
    function resetR3Frame() {
        const r3Frame = document.getElementById('r3-frame');
        if (r3Frame) {
            // Clear iframe by reloading it fresh
            r3Frame.src = 'about:blank';
            // Small delay to ensure clear, then reload
            setTimeout(() => {
                r3Frame.src = 'R3.html?v=2.0.0';
            }, 50);
        }
    }
    
    navButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            navButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const navNum = btn.getAttribute('data-nav');
            console.log('[Frame] Navigation to:', navNum);
            
            if (navNum === '0') {
                // Open Ultimate Guitar Explore
                window.open('https://www.ultimate-guitar.com/explore', 'ultimateGuitar');
            } else if (navNum === '1') {
                // Sample data
                window.open('Sample.html', 'sample', 'width=1400,height=720');
            } else if (navNum === '2') {
                // R3 Linear (1 row Ã— 24) - load in iframe
                resetR3Frame();
                setTimeout(() => {
                    const r3Frame = document.getElementById('r3-frame');
                    if (r3Frame) {
                        r3Frame.src = 'R3.html?v=2.0.0&layout=linear';
                    }
                }, 100);
            } else if (navNum === '3') {
                // R3 Desktop (4 columns) - load in iframe
                resetR3Frame();
                setTimeout(() => {
                    const r3Frame = document.getElementById('r3-frame');
                    if (r3Frame) {
                        r3Frame.src = 'R3.html?v=2.0.0&layout=desktop';
                    }
                }, 100);
            } else if (navNum === '4') {
                // R3 Tablet (3 columns) - load in iframe
                resetR3Frame();
                setTimeout(() => {
                    const r3Frame = document.getElementById('r3-frame');
                    if (r3Frame) {
                        r3Frame.src = 'R3.html?v=2.0.0&layout=tablet';
                    }
                }, 100);
            } else if (navNum === '5') {
                // R3 Mobile (2 columns) - load in iframe
                resetR3Frame();
                setTimeout(() => {
                    const r3Frame = document.getElementById('r3-frame');
                    if (r3Frame) {
                        r3Frame.src = 'R3.html?v=2.0.0&layout=mobile';
                    }
                }, 100);
            } else if (navNum === '6') {
                // Help - open help window
                window.open('help.html', 'helpWindow', 
                    'width=400,height=800,scrollbars=yes,resizable=yes,left=100,top=50');
            }
        });
    });

    updateFrameTimestamp();
    setInterval(updateFrameTimestamp, 60000);

    // Note: iframes have same-origin policy, so cross-iframe communication 
    // via window.R1, window.R2A, window.R3, window.R2B requires all files 
    // to be served from same origin (http://localhost or file://)

    console.log('Frame loaded. All 4 panels should be visible.');
    console.log('Cross-origin restrictions apply if serving via file:// protocol.');
    console.log('Use local HTTP server for full cross-panel testing.');
</script>

</body>
</html>

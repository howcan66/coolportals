<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R2B - Chord Analysis Piano</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #1a1a1a;
            color: #ffffff;
            padding: 0;
            margin: 0;
            display: flex;
            gap: 0;
            height: 100%;
        }

        #r2b-panel {
            flex: 1;
            background-color: #2b2b2b;
            border: 1px solid #444;
            padding: 12px;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        }

        .r2b-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .r2b-header h2 {
            font-size: 1.2rem;
            font-weight: bold;
            color: #000;
        }



        .r2b-content {
            display: flex;
            flex-direction: column;
            flex: 1;
            gap: 16px;
        }

        .r2b-piano-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .r2b-piano-label {
            padding: 8px 16px;
            border: 2px solid #4fc3f7;
            border-radius: 4px;
            font-size: 0.9rem;
            font-weight: bold;
            color: #4fc3f7;
            background-color: transparent;
            min-width: 80px;
            text-align: center;
        }

        .r2b-piano-svg {
            width: 100%;
            height: 250px;
            border: 1px solid #444;
        }

        .r2b-buttons {
            display: flex;
            justify-content: flex-start;
            gap: 10px;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #444;
        }

        .r2b-btn {
            padding: 8px 16px;
            border: 2px solid;
            border-radius: 4px;
            font-size: 0.9rem;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.2s;
            min-width: 80px;
        }

        .r2b-btn-compact {
            min-width: 55px;
            padding: 8px 10px;
        }

        .r2b-btn:hover {
            opacity: 0.8;
        }

        .r2b-btn:active {
            opacity: 0.6;
        }

        .r2b-btn-play {
            background-color: transparent;
            border-color: #8fd694;
            color: #8fd694;
        }

        .r2b-btn-clear {
            background-color: #f4a6a6;
            border-color: #f4a6a6;
            color: black;
        }

        .piano-key {
            cursor: pointer;
            transition: fill 0.1s;
        }

        .piano-key:hover {
            filter: brightness(0.95);
        }
    </style>
</head>
<body>

<section id="r2b-panel">
    <div class="r2b-buttons">
        <div class="r2b-piano-label" title="R3 Chord">
            <span id="r2b-chord-name">â€“</span>
        </div>
        <button class="r2b-btn r2b-btn-play r2b-btn-compact" id="r2b-b12" title="Play R3 Chord">B12</button>
        <button class="r2b-btn r2b-btn-clear" id="r2b-b13" title="Reset R2B Chord">B13</button>
        
        <div id="r2b-duration-control" style="display: inline-block; padding: 8px 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin-left: 15px; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
            <label style="font-weight: bold; margin-right: 6px; color: white; font-size: 15px;">ðŸ”Š <span id="duration-display">2.0s</span></label>
            <label style="margin-left: 4px; color: white; font-size: 11px; cursor: pointer;">
                <input type="radio" name="chord-duration" value="1.0" style="cursor: pointer;"> 1.0s
            </label>
            <label style="margin-left: 4px; color: white; font-size: 11px; cursor: pointer;">
                <input type="radio" name="chord-duration" value="2.0" checked style="cursor: pointer;"> 2.0s
            </label>
            <label style="margin-left: 4px; color: white; font-size: 11px; cursor: pointer;">
                <input type="radio" name="chord-duration" value="3.0" style="cursor: pointer;"> 3.0s
            </label>
        </div>
    </div>

    <div class="r2b-content">
        <div class="r2b-piano-section">
            <svg class="r2b-piano-svg" id="r2b-piano" viewBox="0 0 300 150">
                <!-- 2-octave piano keys generated here -->
            </svg>
        </div>
    </div>
</section>

<script>
    // ===== R2B STATE =====
    
    let currentChord = null;
    let isChordPlaying = false;
    let chordDuration = 2.0;  // Default duration
    let chordVolume = 0.8;    // Default volume (0-1 scale) - hardcoded, users control via OS volume
    
    // Set up duration control listeners
    document.addEventListener('DOMContentLoaded', () => {
        const durationRadios = document.querySelectorAll('input[name="chord-duration"]');
        const durationDisplay = document.getElementById('duration-display');
        
        console.log('[R2B] Found duration radios:', durationRadios.length);
        console.log('[R2B] Default duration:', chordDuration, 's');
        
        durationRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                chordDuration = parseFloat(e.target.value);
                console.log(`[R2B] â­ Chord duration CHANGED to ${chordDuration}s`);
                
                // Update display
                if (durationDisplay) {
                    durationDisplay.textContent = chordDuration + 's';
                    durationDisplay.style.backgroundColor = '#ffeb3b';
                    durationDisplay.style.color = '#000';
                    durationDisplay.style.padding = '2px 6px';
                    durationDisplay.style.borderRadius = '3px';
                    
                    setTimeout(() => {
                        durationDisplay.style.backgroundColor = 'transparent';
                        durationDisplay.style.color = 'white';
                    }, 500);
                }
                
                alert(`Duration changed to ${chordDuration}s`);
                
                // Notify R3 via parent frame
                window.parent.postMessage({
                    type: 'SET_CHORD_DURATION',
                    duration: chordDuration
                }, '*');
            });
        });
        
        console.log('[R2B] Current duration on load:', chordDuration);
        
        // Volume control listener
        if (volumeSlider) {
            volumeSlider.addEventListener('input', (e) => {
                chordVolume = parseFloat(e.target.value) / 100;
                console.log(`[R2B] â­ Chord volume CHANGED to ${chordVolume.toFixed(2)} (${e.target.value}%)`);
                
                // Update display
                if (volumeDisplay) {
                    volumeDisplay.textContent = e.target.value + '%';
                    volumeDisplay.style.backgroundColor = '#ffeb3b';
                    volumeDisplay.style.color = '#000';
                    volumeDisplay.style.padding = '2px 6px';
                    volumeDisplay.style.borderRadius = '3px';
                    
                    setTimeout(() => {
                        volumeDisplay.style.backgroundColor = 'transparent';
                        volumeDisplay.style.color = 'white';
                    }, 500);
                }
            });
        }
    });
    
    // ===== NOTE FREQUENCIES =====
    
    const NOTE_FREQUENCIES = {
        'C4': 261.63, 'C#4': 277.18, 'D4': 293.66, 'D#4': 311.13, 'E4': 329.63, 'F4': 349.23,
        'F#4': 369.99, 'G4': 391.99, 'G#4': 415.30, 'A4': 440.00, 'A#4': 466.16, 'B4': 493.88,
        'C5': 523.25, 'C#5': 554.37, 'D5': 587.33, 'D#5': 622.25, 'E5': 659.25, 'F5': 698.46,
        'F#5': 739.99, 'G5': 783.99, 'G#5': 830.61, 'A5': 880.00, 'A#5': 932.33, 'B5': 987.77
    };

    // ===== R2B INITIALIZATION =====
    
    function initR2B() {
        renderPiano();
        attachButtonListeners();
        exposePublicAPI();

    }

    // ===== PIANO RENDERING (2 OCTAVES: C4-B5) =====
    
    function renderPiano() {
        const svg = document.getElementById('r2b-piano');
        const notes = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
        const octaves = [4, 5];
        
        let xPos = 0;
        const totalWhiteKeys = notes.length * octaves.length;
        const whiteKeyWidth = 300 / totalWhiteKeys;
        const whiteKeyHeight = 120;

        // Draw white keys (all 14 across 2 octaves)
        octaves.forEach(octave => {
            notes.forEach((note, idx) => {
                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('x', xPos);
                rect.setAttribute('y', 0);
                rect.setAttribute('width', whiteKeyWidth);
                rect.setAttribute('height', whiteKeyHeight);
                rect.setAttribute('fill', '#f5f5f5');
                rect.setAttribute('stroke', '#999');
                rect.setAttribute('class', 'piano-key');
                rect.setAttribute('data-note', note + octave);
                svg.appendChild(rect);

                // Add note label (without octave number)
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', xPos + whiteKeyWidth / 2);
                text.setAttribute('y', whiteKeyHeight - 8);
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('font-size', '12');
                text.setAttribute('fill', '#333');
                text.setAttribute('pointer-events', 'none');
                text.textContent = note; // Just note name, no octave number
                svg.appendChild(text);

                xPos += whiteKeyWidth;
            });
        });

        // Draw black keys (10 total: no key after E and B in each octave)
        xPos = 0;
        octaves.forEach((octave, octaveIdx) => {
            const octaveNotes = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
            const blackNotes = [0.5, 1.5, 3.5, 4.5, 5.5];
            
            blackNotes.forEach((position) => {
                const octaveOffset = octaveIdx * 7 * whiteKeyWidth;
                const x = Math.ceil(position) * whiteKeyWidth - (whiteKeyWidth * 0.275) + octaveOffset;
                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('x', x);
                rect.setAttribute('y', 0);
                rect.setAttribute('width', whiteKeyWidth * 0.6);
                rect.setAttribute('height', 72);
                rect.setAttribute('fill', '#1a1a1a');
                rect.setAttribute('stroke', '#000');
                rect.setAttribute('class', 'piano-key');
                
                const whiteNote = octaveNotes[Math.floor(position)];
                let blackNote = whiteNote + '#' + octave;
                rect.setAttribute('data-note', blackNote);
                svg.appendChild(rect);

                // Add black key label (without octave number)
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', x + (whiteKeyWidth * 0.25));
                text.setAttribute('y', 50);
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('font-size', '8');
                text.setAttribute('fill', '#fff');
                text.setAttribute('pointer-events', 'none');
                text.textContent = whiteNote + '#';
                svg.appendChild(text);
            });
        });

        // Attach key listeners
        document.querySelectorAll('#r2b-piano .piano-key').forEach(key => {
            key.addEventListener('click', () => {
                playNote(key.getAttribute('data-note'));
            });
        });
    }

    // ===== PUBLIC API FOR R3 =====
    
    function setChord(chordData) {
        // Defensive validation
        if (!chordData) {
            resetChord();
            return;
        }

        if (typeof chordData.chordName !== 'string' || !Array.isArray(chordData.notes) || chordData.notes.length === 0) {
            console.warn('R2B.setChord: invalid payload', chordData);
            resetChord();
            return;
        }

        currentChord = chordData;
        console.log('[R2B] setChord mode:', chordData.mode, 'tetrad?', chordData.mode === 'tetrad');
        const highlightColor = chordData.mode === 'tetrad' ? '#4fc3f7' : '#ff6b6b';
        console.log('[R2B] Using color:', highlightColor);
        markChordNotes(chordData.notes, highlightColor);
        playChord(chordData.notes);
        updateAnalysis(chordData);
    }

    // ===== CHORD MARKING ON PIANO =====
    
    function markChordNotes(notes, color = '#ff6b6b') {
        // Clear previous markings
        const svg = document.getElementById('r2b-piano');
        svg.querySelectorAll('.piano-key').forEach(key => {
            const note = key.getAttribute('data-note');
            const isBlack = note.includes('#');
            key.setAttribute('fill', isBlack ? '#1a1a1a' : '#f5f5f5');
        });

        // Mark active chord notes
        notes.forEach(note => {
            const key = svg.querySelector(`[data-note="${note}"]`);
            if (key) {
                key.setAttribute('fill', color);
            }
        });
    }

    // ===== AUDIO PLAYBACK =====
    
    // ===== AUDIO (Web Audio API) =====
    
    let AUDIO_CTX = null, AUDIO_MASTER = null;

    function getAudio() {
        if (!AUDIO_CTX) {
            const Ctx = window.AudioContext || window.webkitAudioContext;
            AUDIO_CTX = new Ctx();
            AUDIO_MASTER = AUDIO_CTX.createGain();
            AUDIO_MASTER.gain.value = 0.2;
            AUDIO_MASTER.connect(AUDIO_CTX.destination);
        }
        return { ctx: AUDIO_CTX, master: AUDIO_MASTER };
    }

    function noteToFreq(note) {
        if (!note) return 440;
        const m = note.match(/^([A-GH])([#b]?)(\d)$/i);
        if (!m) return 440;
        let [, ltr, acc, oct] = m; oct = parseInt(oct, 10);
        const name = ltr.toUpperCase() === 'H' ? 'B' : ltr.toUpperCase();
        const key = (name + (acc || '')).toUpperCase();
        const semis = { C:0,'C#':1,DB:1,D:2,'D#':3,EB:3,E:4,F:5,'F#':6,GB:6,G:7,'G#':8,AB:8,A:9,'A#':10,BB:10,'Bb':10,B:11 };
        const semi = semis[key];
        if (semi === undefined) return 440;
        const midi = (oct + 1) * 12 + semi;
        return 440 * Math.pow(2, (midi - 69) / 12);
    }

    function triggerTone(freq, dur = 0.8, when = 0, detune = 0) {
        const { ctx, master } = getAudio();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = 'sine';
        osc.frequency.value = freq;
        osc.detune.value = detune;
        gain.gain.setValueAtTime(0.0001, ctx.currentTime + when);
        gain.gain.exponentialRampToValueAtTime(chordVolume, ctx.currentTime + when + 0.01);
        gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + when + dur);
        osc.connect(gain).connect(master);
        osc.start(ctx.currentTime + when);
        osc.stop(ctx.currentTime + when + dur + 0.05);
    }

    // ===== AUDIO PLAYBACK =====

    function playChord(notes) {
        if (isChordPlaying) return;
        if (!Array.isArray(notes) || !notes.length) return;

        isChordPlaying = true;
        console.log(`[R2B] â­ Playing chord with duration: ${chordDuration}s`);
        console.log(`[R2B] Notes: ${notes.join(', ')}`);
        
        notes.forEach((n, idx) => {
            const f = noteToFreq(n);
            const detune = (idx - (notes.length - 1) / 2) * 4; // slight spread
            triggerTone(f, chordDuration, 0, detune);
        });
        
        // Reset debounce after chord duration
        setTimeout(() => {
            isChordPlaying = false;
        }, chordDuration * 1000 + 100);
    }

    function playNote(note) {
        console.log(`[R2B] Playing note: ${note}`);
        const f = noteToFreq(note);
        triggerTone(f, chordDuration, 0, 0);
    }

    // ===== ANALYSIS DISPLAY =====
    
    function updateAnalysis(chordData) {
        const chordNameElem = document.getElementById('r2b-chord-name');
        if (chordNameElem && chordData.chordName) {
            chordNameElem.textContent = chordData.chordName;
        }
    }

    function clearAnalysis() {
        const chordNameElem = document.getElementById('r2b-chord-name');
        if (chordNameElem) {
            chordNameElem.textContent = 'â€“';
        }
    }

    function resetChord() {
        // Clear piano markings
        const svg = document.getElementById('r2b-piano');
        svg.querySelectorAll('.piano-key').forEach(key => {
            const note = key.getAttribute('data-note');
            const isBlack = note.includes('#');
            key.setAttribute('fill', isBlack ? '#1a1a1a' : '#f5f5f5');
        });

        currentChord = null;
        clearAnalysis();
    }

    // ===== BUTTON HANDLERS =====
    
    function attachButtonListeners() {
        document.getElementById('r2b-b12').addEventListener('click', () => {
            if (currentChord) {
                playChord(currentChord.notes);
            }
        });

        document.getElementById('r2b-b13').addEventListener('click', () => {
            resetChord();
        });
    }

    // ===== POSTMESSAGE LISTENER =====
    
    window.addEventListener('message', (event) => {
        if (event.data.type === 'R3_SEND_TO_R2B') {
            console.log('[R2B] Received from R3:', event.data.payload);
            setChord(event.data.payload);
        }
    });

    // ===== PUBLIC API EXPOSURE =====
    
    function exposePublicAPI() {
        window.R2B = {
            setChord: setChord
        };
    }



    // ===== INITIALIZATION =====
    
    document.addEventListener('DOMContentLoaded', initR2B);
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R3 - Piano Group Prototype</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #1a1a1a;
            color: #ffffff;
            padding: 0;
            margin: 0;
            height: 100%;
            display: flex;
        }

        #r3-panel {
            flex: 1;
            background-color: #2b2b2b;
            border: 1px solid #444;
            padding: 12px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            height: 100%;
            overflow-y: auto;
            gap: 8px;
            align-content: start;
        }

        /* Linear: 1 column (24 rows stacked) */
        body.layout-linear #r3-panel {
            grid-template-columns: 1fr;
            display: flex;
            flex-direction: column;
        }

        /* Force layout based on query parameter */
        body.layout-tablet #r3-panel {
            grid-template-columns: repeat(3, 1fr);
        }

        body.layout-mobile #r3-panel {
            grid-template-columns: repeat(2, 1fr);
        }

        /* Tablet: 3 columns */
        @media (max-width: 1024px) {
            #r3-panel {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* Mobile: 2 columns */
        @media (max-width: 600px) {
            #r3-panel {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .r3-pianogroup {
            display: flex;
            flex-direction: column;
            gap: 2px;
            padding: 6px;
            background: #1a1a1a;
            border-radius: 4px;
            border-left: 3px solid #444;
        }

        .r3-pianogroup.active {
            border-left-color: #4fc3f7;
        }

        .r3-chord-label {
            padding: 6px 12px;
            border: 2px solid #4fc3f7;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
            color: #4fc3f7;
            background-color: transparent;
            min-width: 60px;
            text-align: center;
            margin-right: 12px;
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .r3-row-number {
            padding: 4px 8px;
            border: 2px solid #ff9800;
            border-radius: 3px;
            background-color: transparent;
            color: #ff9800;
            font-size: 12px;
            font-weight: bold;
            min-width: 30px;
            text-align: center;
        }

        .r3-chord-name {
            padding: 0 4px;
            color: #4fc3f7;
        }

        .r3-piano-svg {
            width: 100%;
            height: 50px;
            border: 1px solid #444;
            background-color: #fff;
        }

        /* Linear layout: larger piano keys */
        body.layout-linear .r3-piano-svg {
            height: 150px;
        }

        .r3-controls {
            display: flex;
            gap: 2px;
            justify-content: flex-start;
            align-items: center;
            flex-wrap: wrap;
        }

        .r3-btn {
            width: 22px;
            height: 20px;
            padding: 0;
            border: 1px solid #333;
            border-radius: 2px;
            cursor: pointer;
            transition: opacity 0.2s, transform 0.05s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }

        .r3-btn:hover {
            opacity: 0.85;
        }

        .r3-btn:active {
            transform: scale(0.96);
        }

        .r3-btn.active {
            outline: 2px solid #ffffff;
            outline-offset: 1px;
        }

        .r3-btn-play {
            background-color: #8fd694;
        }

        .r3-btn-triad {
            background-color: #4fc3f7;
        }

        .r3-btn-tetrad {
            background-color: #ffb74d;
        }

        .r3-btn-invert {
            background-color: #ba68c8;
        }

        .r3-btn-send {
            background-color: #4db6ac;
        }

        .r3-btn-chord {
            background-color: #4fc3f7 !important;
            cursor: default !important;
            opacity: 1 !important;
            color: #01579b;
            font-weight: bold;
            min-width: 40px;
            font-size: 9px;
            height: 20px;
        }

        .r3-btn-chord:hover {
            opacity: 1 !important;
        }

        .r3-btn-rownum {
            background-color: #ff9800 !important;
            cursor: default !important;
            opacity: 1 !important;
            min-width: 28px;
            font-size: 9px;
            font-weight: bold;
            color: black;
            height: 20px;
        }

        .r3-btn-rownum:hover {
            opacity: 1 !important;
        }

        .piano-key {
            cursor: pointer;
            transition: fill 0.1s;
        }

        .piano-key:hover {
            filter: brightness(0.95);
        }
    </style>
</head>
<body>

<section id="r3-panel">
    <!-- 24 rows will be generated here by JavaScript -->
</section>

<script>
    // ===== DURATION CONTROL =====
    // Global duration variable accessible from R2B
    window.chordDuration = 2.0;  // Default to 2.0 seconds
    
    // Listen for duration changes from R2B
    window.addEventListener('message', (event) => {
        if (event.data && event.data.type === 'SET_CHORD_DURATION') {
            window.chordDuration = event.data.duration;
            console.log(`[R3] Chord duration set to ${window.chordDuration}s`);
        }
    });

    // ===== R3 STATE - 24 ROWS =====
    
    const groupStates = Array(24).fill(null).map((_, i) => ({
        rowIndex: i + 1,
        chordName: null,
        mode: 'triad',
        inversion: 0,
        notes: [],
        isEmpty: true
    }));

    // ===== NOTE FREQUENCIES =====
    
    const NOTE_FREQUENCIES = {
        'C4': 261.63, 'C#4': 277.18, 'Db4': 277.18, 'D4': 293.66, 'D#4': 311.13, 'Eb4': 311.13, 'E4': 329.63, 'F4': 349.23,
        'F#4': 369.99, 'Gb4': 369.99, 'G4': 391.99, 'G#4': 415.30, 'Ab4': 415.30, 'A4': 440.00, 'A#4': 466.16, 'Bb4': 466.16, 'B4': 493.88,
        'C5': 523.25, 'C#5': 554.37, 'Db5': 554.37, 'D5': 587.33, 'D#5': 622.25, 'Eb5': 622.25, 'E5': 659.25, 'F5': 698.46,
        'F#5': 739.99, 'Gb5': 739.99, 'G5': 783.99, 'G#5': 830.61, 'Ab5': 830.61, 'A5': 880.00, 'A#5': 932.33, 'Bb5': 932.33, 'B5': 987.77
    };

    // ===== R3 INITIALIZATION =====
    
    function initR3() {
        console.log('[R3] initR3() - Initializing 24 rows');
        const panel = document.getElementById('r3-panel');
        console.log('[R3] Panel element:', panel);
        
        if (!panel) {
            console.error('[R3] Panel element not found!');
            return;
        }
        
        for (let i = 0; i < 24; i++) {
            const groupIndex = i;
            const rowIndex = i + 1;
            
            const group = document.createElement('div');
            group.className = 'r3-pianogroup';
            group.id = `r3-pianogroup-${rowIndex}`;
            
            // Chord label (removed - will be in controls as button)
            
            // Piano SVG
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('viewBox', '0 0 200 100');
            svg.setAttribute('preserveAspectRatio', 'none');
            svg.setAttribute('class', 'r3-piano-svg');
            svg.id = `r3-piano-${rowIndex}`;
            
            renderPianoKeysForGroup(svg, rowIndex);
            group.appendChild(svg);
            
            // Controls
            const controls = document.createElement('div');
            controls.className = 'r3-controls';
            controls.id = `r3-controls-${rowIndex}`;
            controls.innerHTML = `
                <button class="r3-btn r3-btn-rownum" disabled title="Row">#${rowIndex}</button>
                <button class="r3-btn r3-btn-chord" disabled title="Chord" id="r3-chord-${rowIndex}">–</button>
                <button class="r3-btn r3-btn-play" onclick="handleButton(${rowIndex}, 'play')" title="Play">B7</button>
                <button class="r3-btn r3-btn-triad" onclick="handleButton(${rowIndex}, 'triad')" title="Triad">B8</button>
                <button class="r3-btn r3-btn-tetrad" onclick="handleButton(${rowIndex}, 'tetrad')" title="Tetrad">B9</button>
                <button class="r3-btn r3-btn-invert" onclick="handleButton(${rowIndex}, 'invert')" title="Inversion">B10</button>
                <button class="r3-btn r3-btn-send" onclick="handleButton(${rowIndex}, 'send')" title="Send to R2B">B11</button>
            `;
            
            group.appendChild(controls);
            panel.appendChild(group);
            if (i === 0 || i === 23) console.log(`[R3] Row ${rowIndex} created`);
        }
        console.log('[R3] 24 rows initialized successfully');
    }
    
    // Initialize immediately
    console.log('[R3] Script starting, document.readyState:', document.readyState);
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            console.log('[R3] DOMContentLoaded - calling initR3()');
            initR3();
        });
    } else {
        console.log('[R3] Document ready - calling initR3() immediately');
        initR3();
    }

    // Detect layout mode
    const layoutMode = new URLSearchParams(window.location.search).get('layout') || 'desktop';

    // ===== PIANO RENDERING =====
    
    function renderPianoKeysForGroup(svg, rowIndex) {
        const notes = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
        const blackNotes = [0.5, 1.5, 3.5, 4.5, 5.5];
        
        let xPos = 0;
        const whiteKeyWidth = 200 / 7;
        const whiteKeyHeight = layoutMode === 'linear' ? 65 : 100;
        
        // Draw white keys
        notes.forEach((note, idx) => {
            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            rect.setAttribute('x', xPos);
            rect.setAttribute('y', 0);
            rect.setAttribute('width', whiteKeyWidth);
            rect.setAttribute('height', whiteKeyHeight);
            rect.setAttribute('fill', '#f5f5f5');
            rect.setAttribute('stroke', '#999');
            rect.setAttribute('class', 'piano-key');
            rect.setAttribute('data-note', note + '4');
            rect.setAttribute('data-row', rowIndex);
            rect.addEventListener('click', () => playNote(note + '4'));

            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            text.setAttribute('x', xPos + whiteKeyWidth / 2);
            text.setAttribute('y', whiteKeyHeight - 8);
            text.setAttribute('text-anchor', 'middle');
            text.setAttribute('font-size', '18');
            text.setAttribute('font-weight', 'bold');
            text.setAttribute('fill', '#333');
            text.setAttribute('pointer-events', 'none');
            text.textContent = note;

            svg.appendChild(rect);
            svg.appendChild(text);

            xPos += whiteKeyWidth;
        });

        // Draw black keys
        blackNotes.forEach((position) => {
            const x = Math.ceil(position) * (200 / 7) - ((200 / 7) * 0.275);
            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            rect.setAttribute('x', x);
            rect.setAttribute('y', 0);
            rect.setAttribute('width', (200 / 7) * 0.55);
            const blackKeyHeight = layoutMode === 'linear' ? 32 : 50;
            rect.setAttribute('height', blackKeyHeight);
            rect.setAttribute('fill', '#1a1a1a');
            rect.setAttribute('stroke', '#000');
            rect.setAttribute('class', 'piano-key');
            
            const whiteNote = notes[Math.floor(position)];
            let blackNote;
            if (whiteNote === 'E' || whiteNote === 'B') {
                return;
            } else {
                blackNote = whiteNote + '#4';
            }
            rect.setAttribute('data-note', blackNote);
            rect.setAttribute('data-row', rowIndex);
            rect.addEventListener('click', () => playNote(blackNote));

            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            text.setAttribute('x', x + ((200 / 7) * 0.25));
            const blackKeyTextY = layoutMode === 'linear' ? 28 : 40;
            text.setAttribute('y', blackKeyTextY);
            text.setAttribute('text-anchor', 'middle');
            const blackKeyFontSize = layoutMode === 'linear' ? '10' : '14';
            text.setAttribute('font-size', blackKeyFontSize);
            text.setAttribute('font-weight', 'bold');
            text.setAttribute('fill', '#fff');
            text.setAttribute('pointer-events', 'none');
            text.textContent = whiteNote + '#';

            svg.appendChild(rect);
            svg.appendChild(text);
        });
    }

    // ===== PUBLIC API FOR R1 =====
    
    function receiveChordFromR1(chordName, rowIndex) {
        if (!chordName || !rowIndex || rowIndex < 1 || rowIndex > 24) {
            console.warn('[R3] Invalid input:', chordName, rowIndex);
            // Log invalid chord from R1
            const logEntry = {
                ts: new Date().toISOString(),
                source: 'R3',
                chord: chordName,
                rowIndex: rowIndex,
                action: 'rejected',
                reason: 'invalid_input'
            };
            const parseLog = JSON.parse(localStorage.getItem('r2a-parse-log') || '[]');
            parseLog.push(logEntry);
            localStorage.setItem('r2a-parse-log', JSON.stringify(parseLog));
            return;
        }

        console.log(`[R3] Receiving chord "${chordName}" for row ${rowIndex}`);
        
        const state = groupStates[rowIndex - 1];
        state.chordName = chordName.replace(/H/gi, 'B');
        state.isEmpty = false;
        
        // Auto-detect mode
        state.mode = /[679]|11|13/.test(state.chordName) ? 'tetrad' : 'triad';
        state.inversion = 0;
        state.notes = computeVoicing(state.chordName, state.mode, state.inversion);
        
        // Check if notes were computed successfully
        if (!state.notes || state.notes.length === 0) {
            console.error('[R3] Failed to compute notes for:', chordName);
            // Log failed chord computation
            const logEntry = {
                ts: new Date().toISOString(),
                source: 'R3',
                chord: chordName,
                rowIndex: rowIndex,
                action: 'failed',
                reason: 'no_notes_computed'
            };
            const parseLog = JSON.parse(localStorage.getItem('r2a-parse-log') || '[]');
            parseLog.push(logEntry);
            localStorage.setItem('r2a-parse-log', JSON.stringify(parseLog));
        } else {
            // Log successful processing
            const logEntry = {
                ts: new Date().toISOString(),
                source: 'R3',
                chord: chordName,
                rowIndex: rowIndex,
                action: 'processed',
                notes: state.notes.length
            };
            const parseLog = JSON.parse(localStorage.getItem('r2a-parse-log') || '[]');
            parseLog.push(logEntry);
            localStorage.setItem('r2a-parse-log', JSON.stringify(parseLog));
        }

        updateChordDisplay(rowIndex);
        playChord(state.notes);
    }
    
    function handleButton(rowIndex, action) {
        const state = groupStates[rowIndex - 1];
        if (state.isEmpty) return;

        switch (action) {
            case 'play':
                const playSvg = document.getElementById(`r3-piano-${rowIndex}`);
                if (playSvg) {
                    highlightChordKeys(playSvg, state.notes, '#ff0000');
                }
                playChord(state.notes, window.chordDuration);  // Use global duration
                break;
            case 'triad':
                state.mode = 'triad';
                state.inversion = 0;
                state.notes = computeVoicing(state.chordName, 'triad', 0);
                updateChordDisplay(rowIndex);
                sendToR2B(rowIndex);
                break;
            case 'tetrad':
                console.log('[R3] B9 (tetrad) pressed for row', rowIndex);
                state.mode = 'tetrad';
                state.inversion = 0;
                state.notes = computeVoicing(state.chordName, 'tetrad', 0);
                console.log('[R3] Tetrad notes:', state.notes);
                updateChordDisplay(rowIndex);
                sendToR2B(rowIndex);
                break;
            case 'invert':
                state.inversion = (state.inversion + 1) % 4;
                state.notes = computeVoicing(state.chordName, state.mode, state.inversion);
                updateChordDisplay(rowIndex);
                sendToR2B(rowIndex);
                break;
            case 'send':
                sendToR2B(rowIndex);
                break;
        }
    }

    // ===== CHORD DISPLAY & MARKING =====
    function highlightChordKeys(svg, notes, color) {
        if (!svg) return;
        svg.querySelectorAll('.piano-key').forEach(key => {
            const isBlack = key.getAttribute('fill') === '#1a1a1a';
            key.setAttribute('fill', isBlack ? '#1a1a1a' : '#f5f5f5');
        });

        if (notes && notes.length) {
            notes.forEach(note => {
                const key = svg.querySelector(`[data-note="${note}"]`);
                if (key) {
                    key.setAttribute('fill', color);
                }
            });
        }
    }

    function updateChordDisplay(rowIndex) {
        const state = groupStates[rowIndex - 1];
        const chordBtn = document.getElementById(`r3-chord-${rowIndex}`);
        const svg = document.getElementById(`r3-piano-${rowIndex}`);
        
        // Update chord button text
        chordBtn.textContent = state.isEmpty ? '–' : state.chordName;

        // Update piano highlighting (mode-aware)
        if (!state.isEmpty) {
            const modeColor = state.mode === 'tetrad' ? '#4fc3f7' : '#8fd694';
            highlightChordKeys(svg, state.notes, modeColor);
        }
    }

    // ===== VOICING COMPUTATION (from integration.html) =====
    
    const CHORD_TABLE = {
      'C':   {tri: ['C4','E4','G4'],   tet: ['C4','E4','G4','B4']},
    'C/E': {tri: ['C4','E4','G4'],   tet: ['C4','E4','G4','B4']},
      'C#':  {tri: ['C#4','E#4','G#4'], tet: ['C#4','E#4','G#4','B#4']},
      'D':   {tri: ['D4','F#4','A4'],  tet: ['D4','F#4','A4','C#5']},
      'D#':  {tri: ['D#4','F##4','A#4'], tet: ['D#4','F##4','A#4','C##5']},
      'E':   {tri: ['E4','G#4','B4'],  tet: ['E4','G#4','B4','D#5']},
      'F':   {tri: ['F4','A4','C5'],   tet: ['F4','A4','C5','E5']},
    'F6':  {tri: ['F4','A4','C5'],   tet: ['F4','A4','C5','D5']},
      'F#':  {tri: ['F#4','A#4','C#5'], tet: ['F#4','A#4','C#5','E#5']},
      'G':   {tri: ['G4','B4','D5'],   tet: ['G4','B4','D5','F#5']},
      'G#':  {tri: ['G#4','B#4','D#5'], tet: ['G#4','B#4','D#5','F##5']},
      'A':   {tri: ['A4','C#5','E5'],  tet: ['A4','C#5','E5','G#5']},
      'A#':  {tri: ['A#4','C##5','E#5'], tet: ['A#4','C##5','E#5','G##5']},
      'B':   {tri: ['B4','D#5','F#5'], tet: ['B4','D#5','F#5','A#5']},
      'Cm':  {tri: ['C4','Eb4','G4'],  tet: ['C4','Eb4','G4','Bb4']},
      'C#m': {tri: ['C#4','E4','G#4'], tet: ['C#4','E4','G#4','B4']},
      'Dm':  {tri: ['D4','F4','A4'],   tet: ['D4','F4','A4','C5']},
      'D#m': {tri: ['D#4','F#4','A#4'], tet: ['D#4','F#4','A#4','C#5']},
      'Em':  {tri: ['E4','G4','B4'],   tet: ['E4','G4','B4','D5']},
      'Fm':  {tri: ['F4','Ab4','C5'],  tet: ['F4','Ab4','C5','Eb5']},
      'F#m': {tri: ['F#4','A4','C#5'], tet: ['F#4','A4','C#5','E5']},
      'Gm':  {tri: ['G4','Bb4','D5'],  tet: ['G4','Bb4','D5','F5']},
      'G#m': {tri: ['G#4','B4','D#5'], tet: ['G#4','B4','D#5','F#5']},
      'Am':  {tri: ['A4','C5','E5'],   tet: ['A4','C5','E5','G5']},
      'A#m': {tri: ['A#4','C#5','E#5'], tet: ['A#4','C#5','E#5','G#5']},
      'Bm':  {tri: ['B4','D5','F#5'],  tet: ['B4','D5','F#5','A5']},
      'C7':  {tri: ['C4','E4','G4'],   tet: ['C4','E4','G4','Bb4']},
      'C#7': {tri: ['C#4','E#4','G#4'], tet: ['C#4','E#4','G#4','B4']},
      'D7':  {tri: ['D4','F#4','A4'],  tet: ['D4','F#4','A4','C5']},
      'D#7': {tri: ['D#4','F##4','A#4'], tet: ['D#4','F##4','A#4','C#5']},
      'E7':  {tri: ['E4','G#4','B4'],  tet: ['E4','G#4','B4','D5']},
      'F7':  {tri: ['F4','A4','C5'],   tet: ['F4','A4','C5','Eb5']},
      'F#7': {tri: ['F#4','A#4','C#5'], tet: ['F#4','A#4','C#5','E5']},
      'G7':  {tri: ['G4','B4','D5'],   tet: ['G4','B4','D5','F5']},
      'G#7': {tri: ['G#4','B#4','D#5'], tet: ['G#4','B#4','D#5','F#5']},
      'A7':  {tri: ['A4','C#5','E5'],  tet: ['A4','C#5','E5','G5']},
      'A#7': {tri: ['A#4','C##5','E#5'], tet: ['A#4','C##5','E#5','G#5']},
      'B7':  {tri: ['B4','D#5','F#5'], tet: ['B4','D#5','F#5','A5']},
      'Cm7': {tri: ['C4','Eb4','G4'],  tet: ['C4','Eb4','G4','Bb4']},
      'C#m7': {tri: ['C#4','E4','G#4'], tet: ['C#4','E4','G#4','B4']},
      'Dm7': {tri: ['D4','F4','A4'],   tet: ['D4','F4','A4','C5']},
      'D#m7': {tri: ['D#4','F#4','A#4'], tet: ['D#4','F#4','A#4','C#5']},
      'Em7': {tri: ['E4','G4','B4'],   tet: ['E4','G4','B4','D5']},
      'Fm7': {tri: ['F4','Ab4','C5'],  tet: ['F4','Ab4','C5','Eb5']},
      'F#m7': {tri: ['F#4','A4','C#5'], tet: ['F#4','A4','C#5','E5']},
      'Gm7': {tri: ['G4','Bb4','D5'],  tet: ['G4','Bb4','D5','F5']},
      'G#m7': {tri: ['G#4','B4','D#5'], tet: ['G#4','B4','D#5','F#5']},
      'Am7': {tri: ['A4','C5','E5'],   tet: ['A4','C5','E5','G5']},
      'A#m7': {tri: ['A#4','C#5','E#5'], tet: ['A#4','C#5','E#5','G#5']},
      'Bm7': {tri: ['B4','D5','F#5'],  tet: ['B4','D5','F#5','A5']},
      'Cmaj7': {tri: ['C4','E4','G4'],   tet: ['C4','E4','G4','B4']},
      'C#maj7': {tri: ['C#4','E#4','G#4'], tet: ['C#4','E#4','G#4','B#4']},
      'Dmaj7': {tri: ['D4','F#4','A4'],  tet: ['D4','F#4','A4','C#5']},
      'D#maj7': {tri: ['D#4','F##4','A#4'], tet: ['D#4','F##4','A#4','C##5']},
      'Emaj7': {tri: ['E4','G#4','B4'],  tet: ['E4','G#4','B4','D#5']},
      'Fmaj7': {tri: ['F4','A4','C5'],   tet: ['F4','A4','C5','E5']},
      'F#maj7': {tri: ['F#4','A#4','C#5'], tet: ['F#4','A#4','C#5','E#5']},
      'Gmaj7': {tri: ['G4','B4','D5'],   tet: ['G4','B4','D5','F#5']},
      'G#maj7': {tri: ['G#4','B#4','D#5'], tet: ['G#4','B#4','D#5','F##5']},
      'Amaj7': {tri: ['A4','C#5','E5'],  tet: ['A4','C#5','E5','G#5']},
      'A#maj7': {tri: ['A#4','C##5','E#5'], tet: ['A#4','C##5','E#5','G##5']},
      'Bmaj7': {tri: ['B4','D#5','F#5'], tet: ['B4','D#5','F#5','A#5']},
      'Cmm': {tri: ['C4','Eb4','Gb4'], tet: ['C4','Eb4','Gb4','A4']},
      'Dmm': {tri: ['D4','F4','Ab4'],  tet: ['D4','F4','Ab4','C5']},
      'Emm': {tri: ['E4','G4','Bb4'],  tet: ['E4','G4','Bb4','D5']},
      'Gmm': {tri: ['G4','Bb4','Db5'], tet: ['G4','Bb4','Db5','E5']},
      'Amm': {tri: ['A4','C5','Eb5'],  tet: ['A4','C5','Eb5','G5']},
      'Bmm': {tri: ['B4','D5','F5'],   tet: ['B4','D5','F5','A5']},
      'Csus2': {tri: ['C4','D4','G4'],   tet: ['C4','D4','G4','B4']},
      'Csus4': {tri: ['C4','F4','G4'],   tet: ['C4','F4','G4','B4']},
      'Dsus2': {tri: ['D4','E4','A4'],   tet: ['D4','E4','A4','C#5']},
      'Dsus4': {tri: ['D4','G4','A4'],   tet: ['D4','G4','A4','C#5']},
      'Esus2': {tri: ['E4','F#4','B4'],  tet: ['E4','F#4','B4','D#5']},
      'Esus4': {tri: ['E4','A4','B4'],   tet: ['E4','A4','B4','D#5']},
      'Fsus2': {tri: ['F4','G4','C5'],   tet: ['F4','G4','C5','E5']},
      'Fsus4': {tri: ['F4','Bb4','C5'],  tet: ['F4','Bb4','C5','E5']},
      'Gsus2': {tri: ['G4','A4','D5'],   tet: ['G4','A4','D5','F#5']},
      'Gsus4': {tri: ['G4','C5','D5'],   tet: ['G4','C5','D5','F#5']},
      'Asus2': {tri: ['A4','B4','E5'],   tet: ['A4','B4','E5','G#5']},
      'Asus4': {tri: ['A4','D5','E5'],   tet: ['A4','D5','E5','G#5']},
      'Bsus2': {tri: ['B4','C#5','F#5'], tet: ['B4','C#5','F#5','A#5']},
      'Bsus4': {tri: ['B4','E5','F#5'],  tet: ['B4','E5','F#5','A#5']}
    };

    function computeVoicing(chordName, mode, inversion) {
        if (!chordName) return [];
        const norm = chordName.replace(/^H/i, 'B');

        // Handle slash chords: e.g., C/E, Am/G
        const parts = norm.split('/');
        const base = parts[0];
        const bass = parts[1] ? parts[1].toUpperCase() : null;

        const entry = CHORD_TABLE[base];
        if (!entry) return [];

        let notes = mode === 'tetrad' ? entry.tet : entry.tri;

        // Convert enharmonic spellings to match piano keys (only sharps on piano)
        notes = notes.map(n => {
            n = n.replace('Eb', 'D#').replace('Ab', 'G#').replace('Bb', 'A#');
            n = n.replace('Db', 'C#').replace('Gb', 'F#');
            n = n.replace('Cb', 'B').replace('Fb', 'E');
            // Remove theoretical double sharps/flats
            n = n.replace('##', '').replace('bb', '');
            n = n.replace('E#', 'F').replace('B#', 'C');
            // Clamp to octave 4 for 1-octave piano
            n = n.replace(/[45]$/, '4');
            return n;
        });

        // If slash bass provided, move that note to the front (bass)
        if (bass) {
            let bassNote = bass.replace(/^H/, 'B');
            bassNote = bassNote.replace('EB','D#').replace('AB','G#').replace('BB','A#');
            bassNote = bassNote.replace('DB','C#').replace('GB','F#');
            bassNote = bassNote.replace('CB','B').replace('FB','E');
            bassNote = bassNote.replace('E#', 'F').replace('B#', 'C');
            bassNote = bassNote + '4';
            // Remove duplicates and unshift bass
            notes = notes.filter(n => n.replace(/[45]$/, '') !== bassNote.replace(/[45]$/, ''));
            notes.unshift(bassNote);
        }

        if (!notes.length) return notes;
        const inv = Math.abs(inversion) % notes.length;
        return notes.slice(inv).concat(notes.slice(0, inv));
    }

    function analyzeChord(chordName) {
        return { type: 'Chord' };
    }
    
    let AUDIO_CTX = null, AUDIO_MASTER = null;

    function getAudio() {
        if (!AUDIO_CTX) {
            const Ctx = window.AudioContext || window.webkitAudioContext;
            AUDIO_CTX = new Ctx();
            AUDIO_MASTER = AUDIO_CTX.createGain();
            AUDIO_MASTER.gain.value = 0.2;
            AUDIO_MASTER.connect(AUDIO_CTX.destination);
        }
        return { ctx: AUDIO_CTX, master: AUDIO_MASTER };
    }

    function noteToFreq(note) {
        if (!note) return 440;
        const m = note.match(/^([A-GH])([#b]?)(\d)$/i);
        if (!m) return 440;
        let [, ltr, acc, oct] = m; oct = parseInt(oct, 10);
        const name = ltr.toUpperCase() === 'H' ? 'B' : ltr.toUpperCase();
        const key = (name + (acc || '')).toUpperCase();
        const semis = { C:0,'C#':1,DB:1,D:2,'D#':3,EB:3,E:4,F:5,'F#':6,GB:6,G:7,'G#':8,AB:8,A:9,'A#':10,BB:10,'Bb':10,B:11 };
        const semi = semis[key];
        if (semi === undefined) return 440;
        const midi = (oct + 1) * 12 + semi;
        return 440 * Math.pow(2, (midi - 69) / 12);
    }

    function triggerTone(freq, dur = 0.8, when = 0, detune = 0) {
        const { ctx, master } = getAudio();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = 'sine';
        osc.frequency.value = freq;
        osc.detune.value = detune;
        gain.gain.setValueAtTime(0.0001, ctx.currentTime + when);
        gain.gain.exponentialRampToValueAtTime(1.0, ctx.currentTime + when + 0.01);
        gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + when + dur);
        osc.connect(gain).connect(master);
        osc.start(ctx.currentTime + when);
        osc.stop(ctx.currentTime + when + dur + 0.05);
    }

    // ===== AUDIO PLAYBACK =====
    
    function playChord(notes, duration = 1.5) {
        if (!Array.isArray(notes) || !notes.length) return;
        console.log(`[R3] Playing chord: ${notes.join(', ')} with duration ${duration}s`);
        notes.forEach((n, idx) => {
            const f = noteToFreq(n);
            const detune = (idx - (notes.length - 1) / 2) * 4; // slight spread
            triggerTone(f, duration, 0, detune);
        });
    }

    function playNote(note, duration = 1.5) {
        console.log(`[R3] Playing note: ${note} with duration ${duration}s`);
        const f = noteToFreq(note);
        triggerTone(f, duration, 0, 0);
    }

    // ===== BUTTON HANDLERS =====
    // (handled inline with onclick attributes)

    function sendToR2B(rowIndex) {
        const state = groupStates[rowIndex - 1];
        if (!state.chordName) return;

        const invNames = ['', '1st inv', '2nd inv', '3rd inv'];
        const displayName = `${state.chordName} (${invNames[state.inversion]})`;

        console.log(`[R3] Sending to R2B: ${displayName}, mode: ${state.mode}`);
        window.parent.postMessage({
            type: 'R3_SEND_TO_R2B',
            payload: {
                chordName: displayName,
                mode: state.mode,
                notes: state.notes,
                rowIndex: rowIndex
            }
        }, '*');
    }

    // ===== POSTMESSAGE LISTENER =====
    
    window.addEventListener('message', (event) => {
        console.log('[R3] Message:', event.data.type);
        
        if (event.data.type === 'R1_LOAD_CHORD') {
            const { chord, rowIndex } = event.data;
            if (chord && rowIndex) {
                receiveChordFromR1(chord, rowIndex);
            }
        }
        else if (event.data.type === 'R3_FOCUS_AND_PLAY') {
            const { rowIndex } = event.data;
            if (rowIndex !== undefined && groupStates[rowIndex] && !groupStates[rowIndex].isEmpty) {
                console.log('[R3] B25 focus and play:', rowIndex);
                // Scroll to row
                const pianoGroup = document.getElementById(`r3-pianogroup-${rowIndex}`);
                if (pianoGroup) {
                    pianoGroup.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                // Play the chord
                handleButton(rowIndex, 'play');
            }
        }
    });

    // Apply layout from query parameter
    function applyLayout() {
        const params = new URLSearchParams(window.location.search);
        const layout = params.get('layout');
        
        if (layout === 'linear') {
            document.body.classList.add('layout-linear');
            console.log('[R3] Applied linear layout (1 row × 24)');
        } else if (layout === 'tablet') {
            document.body.classList.add('layout-tablet');
            console.log('[R3] Applied tablet layout (3 columns)');
        } else if (layout === 'mobile') {
            document.body.classList.add('layout-mobile');
            console.log('[R3] Applied mobile layout (2 columns)');
        } else {
            console.log('[R3] Using desktop layout (4 columns)');
        }
    }

    applyLayout();
    
    console.log('[R3] Script loaded');
</script>

</body>
</html>

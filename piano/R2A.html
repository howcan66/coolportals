<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R2A - Batch Chord Input Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #1a1a1a;
            color: #ffffff;
            padding: 0;
            margin: 0;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        #r2a-panel {
            width: 100%;
            background-color: #2b2b2b;
            border: 1px solid #444;
            padding: 12px;
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
        }

        .r2a-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .r2a-header h2 {
            font-size: 1.3rem;
            font-weight: bold;
            color: #ffffff;
        }



        .r2a-help-text {
            font-size: 0.85rem;
            color: #ddd;
            margin-bottom: 15px;
            line-height: 1.4;
        }

        .r2a-main-container {
            margin-bottom: 12px;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .r2a-main-textarea {
            width: 100%;
            flex: 1;
            padding: 12px;
            border: 1px solid #555;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.95rem;
            line-height: 1.0;
            background-color: #ffffff;
            color: #000;
            resize: none;
            transition: border-color 0.2s;
            min-height: 0;
        }

        .r2a-main-textarea:focus {
            outline: none;
            border-color: #8fd694;
            box-shadow: 0 0 4px rgba(143, 214, 148, 0.3);
        }

        .r2a-chord-preview {
            margin-top: 10px;
            padding: 10px;
            background-color: #0f1419;
            border: 1px solid #4fc3f7;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            color: #4fc3f7;
            max-height: 120px;
            overflow-y: auto;
            line-height: 1.4;
        }

        .r2a-chord-preview-row {
            display: inline-block;
            margin-right: 15px;
            margin-bottom: 5px;
            padding: 3px 6px;
            background-color: #1a4d7f;
            border-radius: 2px;
            white-space: nowrap;
        }

        .r2a-global-buttons {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #444;
        }

        .r2a-btn-group {
            display: flex;
            gap: 10px;
        }

        .r2a-title-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .r2a-title-input {
            flex: 1;
            padding: 8px 10px;
            border: 1px solid #555;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9rem;
            background-color: #ffffff;
            color: #000;
        }


        .r2a-btn-global {
            padding: 8px 16px;
            border: 2px solid;
            border-radius: 4px;
            font-size: 0.9rem;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.2s;
            min-width: 100px;
        }

        .r2a-btn-compact {
            min-width: 60px;
            padding: 8px 10px;
        }

        .r2a-btn-global:hover {
            opacity: 0.8;
        }

        .r2a-btn-global:active {
            opacity: 0.6;
        }

        .r2a-btn-load-all {
            background-color: transparent;
            border-color: #8fd694;
            color: #8fd694;
        }

        .r2a-btn-clear-all {
            background-color: #f4a6a6;
            border-color: #f4a6a6;
            color: black;
        }

        /* Hide R2A buttons on handheld (≤1024px) - buttons in frame header instead */
        @media (max-width: 1024px) {
            .r2a-global-buttons {
                display: none;
            }
        }
    </style>
</head>
<body>

<section id="r2a-panel">
    <div class="r2a-global-buttons">
        <div class="r2a-btn-group">
            <button class="r2a-btn-global r2a-btn-load-all r2a-btn-compact" id="r2a-b5" aria-label="Load All" title="B5LR1">B5</button>
            <button class="r2a-btn-global r2a-btn-clear-all r2a-btn-compact" id="r2a-b6" aria-label="Clear All" title="B6XR2A">B6</button>
            <button class="r2a-btn-global" id="r2a-prev-sample" style="min-width: 35px; border-color: #666; color: #ccc; background-color: #2b2b2b; font-size: 1.1rem; font-weight: bold;">«</button>
            <span id="r2a-sample-display" style="min-width: 50px; text-align: center; color: #888; font-size: 1.1rem; font-weight: bold; display: inline-flex; align-items: center; justify-content: center; padding: 8px 16px;">1/4</span>
            <button class="r2a-btn-global" id="r2a-next-sample" style="min-width: 35px; border-color: #666; color: #ccc; background-color: #2b2b2b; font-size: 1.1rem; font-weight: bold;">»</button>
        </div>
        <div class="r2a-btn-group">
            <button class="r2a-btn-global r2a-btn-compact" id="r2a-b7" aria-label="Download Parse Log" title="Log" style="border-color: #ffb74d; color: #000;">ER</button>
            <button class="r2a-btn-global r2a-btn-compact" id="r2a-b8-clearlog" aria-label="Clear Log" title="Reset Log" style="border-color: #f4a6a6; color: #000;">--</button>
        </div>
    </div>

    <div class="r2a-title-row">
        <input class="r2a-title-input" id="r2a-title" placeholder="# Song Title - Artist" />
    </div>

    <div class="r2a-main-container">
        <textarea 
            class="r2a-main-textarea" 
            id="r2a-main-textarea"
            placeholder="Example:
# Let It Be - The Beatles
C G Am F
When I find myself in times of trouble
C G Am F
Mother Mary comes to me"
            rows="20"
        ></textarea>
        <div id="r2a-chord-preview" class="r2a-chord-preview"></div>
    </div>
</section>

<script>
    console.log('[R2A SCRIPT] Starting execution');
    
    // ===== R2A INITIALIZATION =====

    const DEFAULT_TITLE = '!!! Let It Be - The Beatles';
    const DEFAULT_CHORDS = `C                G                      Am
  Let's dance in style, let's dance for a while
           F                            G
Heaven can wait we're only watching the skies
               Dm                      F
Hoping for the best, but expecting the worst
                       G6   Fmaj7   G6   C
Are you gonna drop the bomb or not?`;

    function initR2A() {
        console.log('[R2A] initR2A() called');
        const textarea = document.getElementById('r2a-main-textarea');
        if (!textarea) {
            console.error('[R2A] Textarea not found!');
            return;
        }
        console.log('[R2A] Textarea found');

        // Clear old format data from localStorage
        const oldData = localStorage.getItem('r2a-data');
        if (oldData) {
            console.log('[R2A] Found old r2a-data format, clearing it');
            localStorage.removeItem('r2a-data');
        }

        // Migrate old data from # to !!!
        const savedTitle = localStorage.getItem('r2a-title');
        if (savedTitle && savedTitle.startsWith('# ')) {
            const newTitle = savedTitle.replace('# ', '!!! ');
            localStorage.setItem('r2a-title', newTitle);
            console.log('[R2A] Migrated title from # to !!!');
        }

        // Always load from storage first
        console.log('[R2A] Calling loadFromStorage()');
        try {
            loadFromStorage();
            console.log('[R2A] loadFromStorage() completed');
        } catch (e) {
            console.error('[R2A] Error in loadFromStorage():', e);
        }
        
        // If still empty after loading, use defaults
        if (!textarea.value.trim()) {
            console.log('[R2A] Textarea empty, setting defaults');
            textarea.value = DEFAULT_TITLE + '\n' + DEFAULT_CHORDS;
            console.log('[R2A] Calling saveToStorage()');
            try {
                saveToStorage();
                console.log('[R2A] saveToStorage() completed');
            } catch (e) {
                console.error('[R2A] Error in saveToStorage():', e);
            }
        }
        
        console.log('[R2A] About to call attachGlobalListeners()');
        attachGlobalListeners();
        console.log('[R2A] attachGlobalListeners() done');
        
        // Initialize sample navigation
        initSampleNavigation();

        console.log('[R2A] initR2A() completed successfully');
    }

    // ===== SAMPLE NAVIGATION =====
    
    let currentSampleIndex = 0;
    
    function initSampleNavigation() {
        const prevBtn = document.getElementById('r2a-prev-sample');
        const nextBtn = document.getElementById('r2a-next-sample');
        
        if (prevBtn) {
            prevBtn.addEventListener('click', () => navigateSample(-1));
            prevBtn.addEventListener('mouseenter', function() { this.style.background = '#3b3b3b'; });
            prevBtn.addEventListener('mouseleave', function() { this.style.background = '#2b2b2b'; });
        }
        if (nextBtn) {
            nextBtn.addEventListener('click', () => navigateSample(1));
            nextBtn.addEventListener('mouseenter', function() { this.style.background = '#3b3b3b'; });
            nextBtn.addEventListener('mouseleave', function() { this.style.background = '#2b2b2b'; });
        }
        updateSampleDisplay();
    }
    
    function navigateSample(direction) {
        const entries = JSON.parse(localStorage.getItem('piano_sample_entries') || '[]');
        if (entries.length === 0) {
            alert('⚠️ No samples available');
            return;
        }
        
        currentSampleIndex += direction;
        
        // Wrap around
        if (currentSampleIndex < 0) {
            currentSampleIndex = entries.length - 1;
        } else if (currentSampleIndex >= entries.length) {
            currentSampleIndex = 0;
        }
        
        updateSampleDisplay();
        loadSampleByIndex(currentSampleIndex);
    }
    
    function updateSampleDisplay() {
        const display = document.getElementById('r2a-sample-display');
        const entries = JSON.parse(localStorage.getItem('piano_sample_entries') || '[]');
        const total = entries.length > 0 ? entries.length : '?';
        if (display) {
            display.textContent = (currentSampleIndex + 1) + '/' + total;
        }
    }
    
    function loadSampleByIndex(index) {
        const entries = JSON.parse(localStorage.getItem('piano_sample_entries') || '[]');
        if (index < 0 || index >= entries.length) {
            console.error('[R2A] Invalid sample index:', index);
            return;
        }
        
        const entry = entries[index];
        
        // Validate entry has required properties
        if (!entry || typeof entry.data !== 'string') {
            console.error('[R2A] Corrupt sample data at index:', index);
            alert('⚠️ Sample data is corrupt. Clear samples and reload.');
            return;
        }
        
        const titleInput = document.getElementById('r2a-title');
        const textarea = document.getElementById('r2a-main-textarea');
        
        if (textarea) {
            textarea.value = entry.data;
            console.log('[R2A] Loaded sample', index + 1, ':', entry.title || 'Untitled');
        }
        if (titleInput) {
            // Extract title from first line or use entry title
            const firstLine = entry.data.split('\n')[0];
            const title = entry.title || entry.name || 'Untitled';
            titleInput.value = firstLine.startsWith('#') ? firstLine : '# ' + title;
        }
        
        saveToStorage();
    }

    // ===== EVENT LISTENERS =====
    
    function attachGlobalListeners() {
        console.log('[R2A] attachGlobalListeners called');
        
        const titleInput = document.getElementById('r2a-title');
        const textarea = document.getElementById('r2a-main-textarea');
        const b5Button = document.getElementById('r2a-b5');
        const b6Button = document.getElementById('r2a-b6');
        const b7Button = document.getElementById('r2a-b7');
        
        console.log('[R2A] titleInput found:', !!titleInput);
        console.log('[R2A] textarea found:', !!textarea);
        console.log('[R2A] b5Button found:', !!b5Button);
        console.log('[R2A] b6Button found:', !!b6Button);
        console.log('[R2A] b7Button found:', !!b7Button);
        
        // Auto-save on blur for both title and textarea
        if (titleInput) titleInput.addEventListener('blur', saveToStorage);
        if (textarea) {
            textarea.addEventListener('blur', saveToStorage);
            // Update preview on input
            textarea.addEventListener('input', updateChordPreview);
            textarea.addEventListener('change', updateChordPreview);
        }
        
        // Global buttons
        if (b5Button) {
            b5Button.addEventListener('click', handleB5Click);
            console.log('[R2A] B5 listener attached');
        }
        if (b6Button) {
            b6Button.addEventListener('click', handleB6Click);
            console.log('[R2A] B6 listener attached');
        }
        if (b7Button) {
            b7Button.addEventListener('click', downloadParseLog);
            console.log('[R2A] B7 listener attached');
        }
        
        const clearLogButton = document.getElementById('r2a-b8-clearlog');
        if (clearLogButton) {
            clearLogButton.addEventListener('click', clearParseLog);
            console.log('[R2A] Clear Log listener attached');
        }
    }

    // ===== CHORD PREVIEW DISPLAY =====
    
    function updateChordPreview() {
        console.log('[R2A] updateChordPreview called');
        const allChords = parseAllChords();
        console.log('[R2A] Chords found:', allChords.length, allChords);
        const preview = document.getElementById('r2a-chord-preview');
        console.log('[R2A] Preview element:', preview);
        
        if (!preview) {
            console.error('[R2A] Preview div not found!');
            return;
        }
        
        if (allChords.length === 0) {
            preview.innerHTML = '<span style="color: #999;">No chords detected</span>';
            console.log('[R2A] No chords, showing empty message');
            return;
        }
        
        const html = allChords
            .map((chord, index) => `<span class="r2a-chord-preview-row">Row ${index + 1}: ${chord}</span>`)
            .join('');
        
        preview.innerHTML = html;
        console.log('[R2A] Preview updated with', allChords.length, 'chords');
    }

    // ===== CHORD PARSING & VALIDATION =====
    
    function parseAllChords() {
        const textarea = document.getElementById('r2a-main-textarea');
        const lines = textarea.value.split('\n');
        const allChords = [];
        let dataLineIndex = 0;

        // Extract odd lines (0-indexed: 0, 2, 4... = lines 1, 3, 5...)
        // Empty lines and comments are skipped WITHOUT affecting the count
        lines.forEach((line, originalIndex) => {
            const trimmed = line.trim();

            // Skip empty lines completely (don't count them)
            if (!trimmed) {
                return;
            }
            
            // Skip header/comment lines completely (don't count them)
            if (trimmed.startsWith('#') || trimmed.startsWith('<!--')) {
                return;
            }

            // Only non-empty, non-comment lines count in the alternation
            if (dataLineIndex % 2 === 0) { // Chord line
                const tokens = trimmed.split(/\s+/);

                tokens.forEach((token) => {
                    const result = validateChordDetailed(token);
                    if (result.valid) {
                        const absoluteIndex = allChords.length + 1;
                        console.log(`[R2A Parse] #${absoluteIndex}: ${result.value} (line: ${trimmed})`);
                        allChords.push(result.value);
                        // Log valid chords too for debugging
                        appendParseLog({
                            ts: new Date().toISOString(),
                            token,
                            normalized: result.value,
                            status: 'valid',
                            lineNumber: originalIndex + 1,
                            lineText: trimmed
                        });
                    } else {
                        appendParseLog({
                            ts: new Date().toISOString(),
                            token,
                            reason: result.reason,
                            status: 'invalid',
                            lineNumber: originalIndex + 1,
                            lineText: trimmed
                        });
                    }
                });
            }

            // Next non-header, non-empty line
            dataLineIndex += 1;
        });
        
        return allChords;
    }

    function extractTitleLine() {
        const titleInput = document.getElementById('r2a-title');
        
        // First try to get from title input field
        if (titleInput && titleInput.value.trim()) {
            return titleInput.value.trim();
        }
        
        // Fallback: search in textarea
        const textarea = document.getElementById('r2a-main-textarea');
        const lines = textarea.value.split('\n');
        
        for (const line of lines) {
            const trimmed = line.trim();
            if (trimmed.startsWith('#') || trimmed.startsWith('!!!')) {
                return trimmed;
            }
        }
        return '';
    }

    const CHORD_REGEX = /^(?=.{1,10}$)[A-GH](?:#|b)?(?:maj|m|dim|aug|sus(?:2|4)?)?(?:2|4|5|6|7|9|11|13)?(?:(?:#|b)(?:5|9|11|13))?(?:add(?:9|11|13))?(?:\/[A-GH](?:#|b)?)?$/i;

    function validateChord(chord) {
        const trimmed = chord.trim();
        if (!trimmed) return null;
        if (!CHORD_REGEX.test(trimmed)) return null;
        
        // Check for duplicate add/extension
        const match = trimmed.match(/(\d+).*add(\d+)/i);
        if (match && match[1] === match[2]) return null;
        
        // Normalize H→B (including slash bass)
        return trimmed.replace(/^H/i, 'B').replace(/\/(H)/i, '/B');
    }

    function validateChordDetailed(chord) {
        const trimmed = chord.trim();
        if (!trimmed) return { valid: false, reason: 'empty' };
        
        // Reject single notes (must have at least 2 characters: note + something)
        if (trimmed.length < 2) {
            console.log(`[R2A] Chord validation failed for "${trimmed}" - too short (single character)`);
            return { valid: false, reason: 'too-short' };
        }
        
        // Normalize enharmonic equivalents BEFORE validation
        // Bb→A#, Eb→D#, Ab→G#, Db→C#, Gb→F#, Cb→B
        let normalized = trimmed
            .replace(/Bb/g, 'A#')
            .replace(/Eb/g, 'D#')
            .replace(/Ab/g, 'G#')
            .replace(/Db/g, 'C#')
            .replace(/Gb/g, 'F#')
            .replace(/Cb/g, 'B');
        
        // Check regex
        if (!CHORD_REGEX.test(normalized)) {
            console.log(`[R2A] Chord validation failed for "${trimmed}" → "${normalized}" - regex mismatch`);
            return { valid: false, reason: 'regex' };
        }

        // Check for duplicate add/extension
        const match = normalized.match(/(\d+).*add(\d+)/i);
        if (match && match[1] === match[2]) {
            console.log(`[R2A] Chord validation failed for "${normalized}" - duplicate add`);
            return { valid: false, reason: 'duplicate-add' };
        }

        // Normalize H→B (including slash bass)
        const final = normalized.replace(/^H/i, 'B').replace(/\/(H)/i, '/B');
        console.log(`[R2A] Chord validation passed for "${trimmed}" → "${final}"`);
        
        return {
            valid: true,
            value: final
        };
    }

    const PARSE_LOG_KEY = 'r2a-parse-log';

    function appendParseLog(entry) {
        const log = JSON.parse(localStorage.getItem(PARSE_LOG_KEY) || '[]');
        log.push(entry);
        localStorage.setItem(PARSE_LOG_KEY, JSON.stringify(log));
    }

    function downloadParseLog() {
        const log = JSON.parse(localStorage.getItem(PARSE_LOG_KEY) || '[]');
        if (!log.length) {
            alert('No chords logged yet.');
            return;
        }

        const content = log.map(item => {
            // R2A validation logs
            if (item.status === 'valid') {
                return `[${item.ts}] R2A | line ${item.lineNumber} | ✓ VALID | token="${item.token}" → "${item.normalized}" | lineText="${item.lineText}"`;
            } else if (item.status === 'invalid') {
                return `[${item.ts}] R2A | line ${item.lineNumber} | ✗ INVALID | token="${item.token}" | reason=${item.reason} | lineText="${item.lineText}"`;
            }
            // R1→R3 flow logs
            else if (item.source === 'R1') {
                return `[${item.ts}] R1 | row ${item.rowIndex} | → SENT TO R3 | chord="${item.chord}"`;
            } else if (item.source === 'R3' && item.action === 'processed') {
                return `[${item.ts}] R3 | row ${item.rowIndex} | ✓ PROCESSED | chord="${item.chord}" | notes=${item.notes}`;
            } else if (item.source === 'R3' && item.action === 'rejected') {
                return `[${item.ts}] R3 | row ${item.rowIndex} | ✗ REJECTED | chord="${item.chord}" | reason=${item.reason}`;
            } else if (item.source === 'R3' && item.action === 'failed') {
                return `[${item.ts}] R3 | row ${item.rowIndex} | ✗ FAILED | chord="${item.chord}" | reason=${item.reason}`;
            }
            return `[${item.ts}] UNKNOWN | ${JSON.stringify(item)}`;
        }).join('\n');

        const blob = new Blob([content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'r2a-parse-log.txt';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function clearParseLog() {
        const log = JSON.parse(localStorage.getItem(PARSE_LOG_KEY) || '[]');
        if (!log.length) {
            alert('Log is already empty.');
            return;
        }
        
        if (confirm(`Clear ${log.length} log entries?`)) {
            localStorage.removeItem(PARSE_LOG_KEY);
            alert('✓ Log cleared');
        }
    }

    // ===== R1 COMMUNICATION (via parent frame) =====
    
    function sendToR1(chords, titleLine = '') {
        console.log('[R2A] sendToR1 called with:', chords.length, 'chords');
        console.log('[R2A] Chords array:', chords);
        console.log('[R2A] Title:', titleLine);
        
        // Send to parent frame, which will route to R1
        window.parent.postMessage({
            type: 'R2A_LOAD_CHORDS',
            chords: chords,
            titleLine: titleLine
        }, '*');
        
        console.log('[R2A] postMessage sent to parent');
    }

    function sendToR3(chords, titleLine = '') {
        console.log('[R2A] sendToR3 called with:', chords.length, 'chords');
        console.log('[R2A] Chords array:', chords);
        console.log('[R2A] Title:', titleLine);
        
        // Send directly to parent frame, which will route to R3
        window.parent.postMessage({
            type: 'R2A_LOAD_TO_R3',
            chords: chords,
            titleLine: titleLine
        }, '*');
        
        console.log('[R2A] postMessage sent to parent for R3');
    }

    // ===== B5: LOAD ALL =====
    
    function handleB5Click() {
        console.log('[R2A] B5 clicked');
        const textarea = document.getElementById('r2a-main-textarea');
        console.log('[R2A] Textarea value length:', textarea.value.length);
        console.log('[R2A] Textarea first 100 chars:', textarea.value.substring(0, 100));
        
        const allChords = parseAllChords();
        const titleLine = extractTitleLine();
        
        console.log('[R2A] Parsed chords count:', allChords.length);
        console.log('[R2A] Parsed chords:', allChords);
        console.log('[R2A] Title line:', titleLine);
        
        if (allChords.length === 0) {
            console.log('[R2A] ERROR: No valid chords found');
            alert('❌ No valid chords found in textarea');
            return;
        }

        console.log('[R2A] Sending directly to R3:', allChords.length, 'chords');
        sendToR3(allChords, titleLine);
        const maxRows = Math.min(allChords.length, 24);
        alert('✅ Sent ' + allChords.length + ' chords to R3\n(Rows 1–' + maxRows + ')');
    }

    // ===== B6: CLEAR ALL (R2A ONLY) =====
    
    function handleB6Click() {
        const titleInput = document.getElementById('r2a-title');
        const textarea = document.getElementById('r2a-main-textarea');
        if (textarea) {
            textarea.value = '';
        }
        if (titleInput) {
            titleInput.value = '';
        }
        // Clear localStorage
        localStorage.removeItem('r2a-title');
        localStorage.removeItem('r2a-chords');
        console.log('[R2A] B6: Cleared title, textarea, and localStorage');
    }

    // ===== STORAGE (PERSISTENCE) =====
    
    function saveToStorage() {
        const titleInput = document.getElementById('r2a-title');
        const textarea = document.getElementById('r2a-main-textarea');
        if (!textarea) return;

        // Get title from input field, clean it up
        let titleLine = '';
        if (titleInput && titleInput.value.trim()) {
            let title = titleInput.value.trim();
            // Remove # prefix if present
            title = title.replace(/^#+\s*/, '').trim();
            titleLine = '!!! ' + title;
        }

        // Get chord lines from textarea
        const chordLines = textarea.value.trim();
        
        // Always ensure title exists
        if (!titleLine) {
            titleLine = DEFAULT_TITLE;
        }
        
        // Save title and chords separately
        localStorage.setItem('r2a-title', titleLine);
        localStorage.setItem('r2a-chords', chordLines);
    }

    function loadFromStorage() {
        const titleInput = document.getElementById('r2a-title');
        const textarea = document.getElementById('r2a-main-textarea');
        if (!textarea) return;

        const savedTitle = localStorage.getItem('r2a-title');
        const savedChords = localStorage.getItem('r2a-chords');

        // Load title to input field
        if (titleInput && savedTitle) {
            let displayTitle = savedTitle.replace(/^!!!\s*/, '');
            titleInput.value = '# ' + displayTitle;
        }
        
        // Load chords to textarea
        if (savedChords) {
            textarea.value = savedChords;
        }
    }

    // ===== TIMESTAMP =====
    // ===== MESSAGE LISTENER (from Sample.html or frame) =====
    window.addEventListener('message', (event) => {
        // Handle R2A button clicks from frame header (handheld devices)
        if (event.data && event.data.type === 'R2A_BUTTON_CLICK') {
            const button = event.data.button;
            console.log('[R2A] Button click from frame header:', button);
            
            // Route to appropriate button handler
            if (button === 'b5') handleB5Click();
            else if (button === 'b6') handleB6Click();
            else if (button === 'er') document.getElementById('r2a-b7')?.click();
            else if (button === 'clearlog') document.getElementById('r2a-b8-clearlog')?.click();
            else if (button === 'prev-sample') navigateSample(-1);
            else if (button === 'next-sample') navigateSample(1);
            return;
        }

        if (event.data && event.data.type === 'LOAD_CHORD_DATA') {
            console.log('[R2A] Message received');
            const titleInput = document.getElementById('r2a-title');
            const textarea = document.getElementById('r2a-main-textarea');
            
            if (titleInput && textarea) {
                const raw = event.data.data || '';
                console.log('[R2A] Raw data:', raw.substring(0, 50));
                
                const lines = raw.split('\n');
                let titleLine = '';
                const chordLines = [];

                // Look for !!! marker or use first non-empty line as title
                let titleFound = false;
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    const trimmed = line.trim();
                    
                    if (trimmed.startsWith('!!!') && !titleFound) {
                        titleLine = trimmed.replace(/^!!!\s*/, '');
                        titleFound = true;
                        console.log('[R2A] Found !!! marker:', titleLine);
                    } else if (!titleFound && trimmed && !trimmed.startsWith('<!--')) {
                        // Use first non-empty line as title if no !!! marker
                        titleLine = trimmed;
                        titleFound = true;
                        console.log('[R2A] Using first line as title:', titleLine);
                    } else if (titleFound) {
                        // After title found, everything else is chords/lyrics
                        chordLines.push(line);
                    }
                }

                // Use default title if nothing found
                if (!titleLine) {
                    titleLine = 'Let It Be - The Beatles';
                    console.log('[R2A] No title found, using default');
                }

                console.log('[R2A] Title:', titleLine);
                console.log('[R2A] Chord lines:', chordLines.length);

                // Put title in the title input field (top row)
                titleInput.value = '# ' + titleLine;
                
                // Put chords/lyrics in the textarea
                textarea.value = chordLines.join('\n');
                console.log('[R2A] Title input updated:', titleInput.value);
                
                saveToStorage();
            }
        }
    });



    // ===== INITIALIZATION =====
    
    console.log('[R2A] Adding DOMContentLoaded listener');
    document.addEventListener('DOMContentLoaded', () => {
        console.log('[R2A] DOMContentLoaded fired, calling initR2A()');
        initR2A();
    });
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R3 - Piano Group Prototype</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #1a1a1a;
            color: #ffffff;
            padding: 0;
            margin: 0;
            height: 100%;
            display: flex;
        }

        #r3-panel {
            flex: 1;
            background-color: #2b2b2b;
            border: 1px solid #444;
            padding: 12px;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .r3-pianogroup {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
        }

        .r3-chord-label {
            padding: 6px 12px;
            border: 2px solid #4fc3f7;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
            color: #4fc3f7;
            background-color: transparent;
            min-width: 60px;
            text-align: center;
            margin-right: 12px;
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .r3-row-number {
            padding: 4px 8px;
            border: 2px solid #ff9800;
            border-radius: 3px;
            background-color: transparent;
            color: #ff9800;
            font-size: 12px;
            font-weight: bold;
            min-width: 30px;
            text-align: center;
        }

        .r3-chord-name {
            padding: 0 4px;
            color: #4fc3f7;
        }

        .r3-piano-svg {
            width: 100%;
            height: 80px;
            border: 1px solid #444;
            background-color: #fff;
        }

        .r3-controls {
            display: flex;
            gap: 6px;
            justify-content: flex-start;
            align-items: center;
            flex-wrap: wrap;
        }

        .r3-btn {
            width: 28px;
            height: 28px;
            padding: 0;
            border: 1px solid #333;
            border-radius: 3px;
            cursor: pointer;
            transition: opacity 0.2s, transform 0.05s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .r3-btn:hover {
            opacity: 0.85;
        }

        .r3-btn:active {
            transform: scale(0.96);
        }

        .r3-btn.active {
            outline: 2px solid #ffffff;
            outline-offset: 1px;
        }

        .r3-btn-play {
            background-color: #8fd694;
        }

        .r3-btn-triad {
            background-color: #4fc3f7;
        }

        .r3-btn-tetrad {
            background-color: #ffb74d;
        }

        .r3-btn-invert {
            background-color: #ba68c8;
        }

        .r3-btn-send {
            background-color: #4db6ac;
        }

        .piano-key {
            cursor: pointer;
            transition: fill 0.1s;
        }

        .piano-key:hover {
            filter: brightness(0.95);
        }
    </style>
</head>
<body>

<section id="r3-panel">
    <div class="r3-pianogroup" id="r3-pianogroup-1">
        <svg class="r3-piano-svg" id="r3-piano-1" viewBox="0 0 200 100" preserveAspectRatio="none">
            <!-- Piano keys generated here -->
        </svg>
        <div class="r3-controls" id="r3-controls-1">
            <div class="r3-chord-label" id="r3-label-1">â€“</div>
            <button class="r3-btn r3-btn-play" data-action="play" data-group="1" title="Play R3">B7</button>
            <button class="r3-btn r3-btn-triad" data-action="triad" data-group="1" title="Triad">B8</button>
            <button class="r3-btn r3-btn-tetrad" data-action="tetrad" data-group="1" title="Tetrad">B9</button>
            <button class="r3-btn r3-btn-invert" data-action="invert" data-group="1" title="Inversion">B10</button>
            <button class="r3-btn r3-btn-send" data-action="send" data-group="1" title="Play to R2B">B11</button>
        </div>
    </div>
</section>

<script>
    // ===== R3 STATE =====
    
    const groupState = {
        chordName: null,
        rowIndex: null,
        mode: 'triad',
        inversion: 0,
        notes: []
    };

    // ===== NOTE FREQUENCIES =====
    
    const NOTE_FREQUENCIES = {
        'C4': 261.63, 'C#4': 277.18, 'D4': 293.66, 'D#4': 311.13, 'E4': 329.63, 'F4': 349.23,
        'F#4': 369.99, 'G4': 391.99, 'G#4': 415.30, 'A4': 440.00, 'A#4': 466.16, 'B4': 493.88,
        'C5': 523.25, 'C#5': 554.37, 'D5': 587.33, 'D#5': 622.25, 'E5': 659.25, 'F5': 698.46,
        'F#5': 739.99, 'G5': 783.99, 'G#5': 830.61, 'A5': 880.00, 'A#5': 932.33, 'B5': 987.77
    };

    // ===== R3 INITIALIZATION =====
    
    function initR3() {
        console.log('[R3] initR3() called');
        renderPianoKeys();
        attachButtonListeners();
    }

    // Initialize immediately (don't wait for DOMContentLoaded)
    console.log('[R3] Script running, calling initR3()');
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            console.log('[R3] DOMContentLoaded fired');
            initR3();
        });
    } else {
        console.log('[R3] Document already loaded, calling initR3() immediately');
        initR3();
    }

    // ===== PIANO RENDERING =====
    
    function renderPianoKeys() {
        console.log('[R3] renderPianoKeys called');
        const svg = document.getElementById('r3-piano-1');
        console.log('[R3] SVG element:', svg);
        
        if (!svg) {
            console.error('[R3] SVG element not found!');
            return;
        }
        
        const notes = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
        const blackNotes = [0.5, 1.5, 3.5, 4.5, 5.5];
        
        let xPos = 0;
        const whiteKeyWidth = 200 / 7;
        const whiteKeyHeight = 100;
        
        // Draw white keys
        notes.forEach((note, idx) => {
            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            rect.setAttribute('x', xPos);
            rect.setAttribute('y', 0);
            rect.setAttribute('width', whiteKeyWidth);
            rect.setAttribute('height', whiteKeyHeight);
            rect.setAttribute('fill', '#f5f5f5');
            rect.setAttribute('stroke', '#999');
            rect.setAttribute('class', 'piano-key');
            rect.setAttribute('data-note', note + '4');
            svg.appendChild(rect);

            // Add note label
            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            text.setAttribute('x', xPos + whiteKeyWidth / 2);
            text.setAttribute('y', whiteKeyHeight - 8);
            text.setAttribute('text-anchor', 'middle');
            text.setAttribute('font-size', '18');
            text.setAttribute('font-weight', 'bold');
            text.setAttribute('fill', '#333');
            text.setAttribute('pointer-events', 'none');
            text.textContent = note;
            svg.appendChild(text);

            xPos += whiteKeyWidth;
        });

        // Draw black keys
        xPos = 0;
        blackNotes.forEach((position) => {
            const x = (position * whiteKeyWidth) - (whiteKeyWidth * 0.275);
            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            rect.setAttribute('x', x);
            rect.setAttribute('y', 0);
            rect.setAttribute('width', whiteKeyWidth * 0.55);
            rect.setAttribute('height', 60);
            rect.setAttribute('fill', '#1a1a1a');
            rect.setAttribute('stroke', '#000');
            rect.setAttribute('class', 'piano-key');
            
            const whiteNote = notes[Math.floor(position)];
            let blackNote;
            if (whiteNote === 'E' || whiteNote === 'B') {
                return;
            } else {
                blackNote = whiteNote + '#4';
            }
            rect.setAttribute('data-note', blackNote);
            svg.appendChild(rect);

            // Add black key label
            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            text.setAttribute('x', x + (whiteKeyWidth * 0.25));
            text.setAttribute('y', 45);
            text.setAttribute('text-anchor', 'middle');
            text.setAttribute('font-size', '14');
            text.setAttribute('font-weight', 'bold');
            text.setAttribute('fill', '#fff');
            text.setAttribute('pointer-events', 'none');
            text.textContent = whiteNote + '#';
            svg.appendChild(text);
        });

        // Attach key listeners
        document.querySelectorAll('#r3-piano-1 .piano-key').forEach(key => {
            key.addEventListener('click', () => {
                playNote(key.getAttribute('data-note'));
            });
        });
    }

    // ===== PUBLIC API FOR R1 =====
    
    function receiveChordFromR1(chordName, rowIndex) {
        if (!chordName || !rowIndex) {
            console.warn('R3.receiveChordFromR1: invalid params', chordName, rowIndex);
            return;
        }

        groupState.chordName = chordName;
        groupState.rowIndex = rowIndex;
        
        // Auto-detect mode based on chord name
        if (/[679]|11|13/.test(chordName)) {
            groupState.mode = 'tetrad';
        } else {
            groupState.mode = 'triad';
        }
        
        groupState.inversion = 0; // Reset inversion when new chord loaded
        groupState.notes = computeVoicing(chordName, groupState.mode, groupState.inversion);

        updateChordDisplay(chordName, groupState.notes, rowIndex);
        playChord(groupState.notes);
    }

    // ===== CHORD DISPLAY & MARKING =====
    
    function updateChordDisplay(chordName, notes, rowIndex) {
        const rowLabel = document.getElementById('r3-label-1');
        rowLabel.textContent = '';
        
        if (rowIndex) {
            const rowSpan = document.createElement('span');
            rowSpan.className = 'r3-row-number';
            rowSpan.textContent = `#${rowIndex}`;
            rowLabel.appendChild(rowSpan);
            
            const chordSpan = document.createElement('span');
            chordSpan.className = 'r3-chord-name';
            chordSpan.textContent = chordName;
            rowLabel.appendChild(chordSpan);
        } else {
            rowLabel.textContent = chordName;
        }

        // Clear previous markings
        const svg = document.getElementById('r3-piano-1');
        svg.querySelectorAll('.piano-key').forEach(key => {
            const note = key.getAttribute('data-note');
            const isBlack = note.includes('#');
            key.setAttribute('fill', isBlack ? '#1a1a1a' : '#f5f5f5');
        });

        // Mark active chord notes
        notes.forEach(note => {
            const key = svg.querySelector(`[data-note="${note}"]`);
            if (key) {
                key.setAttribute('fill', '#8fd694');
            }
        });

        updateGroupButtons();
    }

    // ===== VOICING COMPUTATION (from integration.html) =====
    
    const CHORD_TABLE = {
      'C':   {tri: ['C4','E4','G4'],   tet: ['C4','E4','G4','B4']},
    'C/E': {tri: ['C4','E4','G4'],   tet: ['C4','E4','G4','B4']},
      'C#':  {tri: ['C#4','E#4','G#4'], tet: ['C#4','E#4','G#4','B#4']},
      'D':   {tri: ['D4','F#4','A4'],  tet: ['D4','F#4','A4','C#5']},
      'D#':  {tri: ['D#4','F##4','A#4'], tet: ['D#4','F##4','A#4','C##5']},
      'E':   {tri: ['E4','G#4','B4'],  tet: ['E4','G#4','B4','D#5']},
      'F':   {tri: ['F4','A4','C5'],   tet: ['F4','A4','C5','E5']},
    'F6':  {tri: ['F4','A4','C5'],   tet: ['F4','A4','C5','D5']},
      'F#':  {tri: ['F#4','A#4','C#5'], tet: ['F#4','A#4','C#5','E#5']},
      'G':   {tri: ['G4','B4','D5'],   tet: ['G4','B4','D5','F#5']},
      'G#':  {tri: ['G#4','B#4','D#5'], tet: ['G#4','B#4','D#5','F##5']},
      'A':   {tri: ['A4','C#5','E5'],  tet: ['A4','C#5','E5','G#5']},
      'A#':  {tri: ['A#4','C##5','E#5'], tet: ['A#4','C##5','E#5','G##5']},
      'B':   {tri: ['B4','D#5','F#5'], tet: ['B4','D#5','F#5','A#5']},
      'Cm':  {tri: ['C4','Eb4','G4'],  tet: ['C4','Eb4','G4','Bb4']},
      'C#m': {tri: ['C#4','E4','G#4'], tet: ['C#4','E4','G#4','B4']},
      'Dm':  {tri: ['D4','F4','A4'],   tet: ['D4','F4','A4','C5']},
      'D#m': {tri: ['D#4','F#4','A#4'], tet: ['D#4','F#4','A#4','C#5']},
      'Em':  {tri: ['E4','G4','B4'],   tet: ['E4','G4','B4','D5']},
      'Fm':  {tri: ['F4','Ab4','C5'],  tet: ['F4','Ab4','C5','Eb5']},
      'F#m': {tri: ['F#4','A4','C#5'], tet: ['F#4','A4','C#5','E5']},
      'Gm':  {tri: ['G4','Bb4','D5'],  tet: ['G4','Bb4','D5','F5']},
      'G#m': {tri: ['G#4','B4','D#5'], tet: ['G#4','B4','D#5','F#5']},
      'Am':  {tri: ['A4','C5','E5'],   tet: ['A4','C5','E5','G5']},
      'A#m': {tri: ['A#4','C#5','E#5'], tet: ['A#4','C#5','E#5','G#5']},
      'Bm':  {tri: ['B4','D5','F#5'],  tet: ['B4','D5','F#5','A5']},
      'C7':  {tri: ['C4','E4','G4'],   tet: ['C4','E4','G4','Bb4']},
      'C#7': {tri: ['C#4','E#4','G#4'], tet: ['C#4','E#4','G#4','B4']},
      'D7':  {tri: ['D4','F#4','A4'],  tet: ['D4','F#4','A4','C5']},
      'D#7': {tri: ['D#4','F##4','A#4'], tet: ['D#4','F##4','A#4','C#5']},
      'E7':  {tri: ['E4','G#4','B4'],  tet: ['E4','G#4','B4','D5']},
      'F7':  {tri: ['F4','A4','C5'],   tet: ['F4','A4','C5','Eb5']},
      'F#7': {tri: ['F#4','A#4','C#5'], tet: ['F#4','A#4','C#5','E5']},
      'G7':  {tri: ['G4','B4','D5'],   tet: ['G4','B4','D5','F5']},
      'G#7': {tri: ['G#4','B#4','D#5'], tet: ['G#4','B#4','D#5','F#5']},
      'A7':  {tri: ['A4','C#5','E5'],  tet: ['A4','C#5','E5','G5']},
      'A#7': {tri: ['A#4','C##5','E#5'], tet: ['A#4','C##5','E#5','G#5']},
      'B7':  {tri: ['B4','D#5','F#5'], tet: ['B4','D#5','F#5','A5']},
      'Cm7': {tri: ['C4','Eb4','G4'],  tet: ['C4','Eb4','G4','Bb4']},
      'C#m7': {tri: ['C#4','E4','G#4'], tet: ['C#4','E4','G#4','B4']},
      'Dm7': {tri: ['D4','F4','A4'],   tet: ['D4','F4','A4','C5']},
      'D#m7': {tri: ['D#4','F#4','A#4'], tet: ['D#4','F#4','A#4','C#5']},
      'Em7': {tri: ['E4','G4','B4'],   tet: ['E4','G4','B4','D5']},
      'Fm7': {tri: ['F4','Ab4','C5'],  tet: ['F4','Ab4','C5','Eb5']},
      'F#m7': {tri: ['F#4','A4','C#5'], tet: ['F#4','A4','C#5','E5']},
      'Gm7': {tri: ['G4','Bb4','D5'],  tet: ['G4','Bb4','D5','F5']},
      'G#m7': {tri: ['G#4','B4','D#5'], tet: ['G#4','B4','D#5','F#5']},
      'Am7': {tri: ['A4','C5','E5'],   tet: ['A4','C5','E5','G5']},
      'A#m7': {tri: ['A#4','C#5','E#5'], tet: ['A#4','C#5','E#5','G#5']},
      'Bm7': {tri: ['B4','D5','F#5'],  tet: ['B4','D5','F#5','A5']},
      'Cmaj7': {tri: ['C4','E4','G4'],   tet: ['C4','E4','G4','B4']},
      'C#maj7': {tri: ['C#4','E#4','G#4'], tet: ['C#4','E#4','G#4','B#4']},
      'Dmaj7': {tri: ['D4','F#4','A4'],  tet: ['D4','F#4','A4','C#5']},
      'D#maj7': {tri: ['D#4','F##4','A#4'], tet: ['D#4','F##4','A#4','C##5']},
      'Emaj7': {tri: ['E4','G#4','B4'],  tet: ['E4','G#4','B4','D#5']},
      'Fmaj7': {tri: ['F4','A4','C5'],   tet: ['F4','A4','C5','E5']},
      'F#maj7': {tri: ['F#4','A#4','C#5'], tet: ['F#4','A#4','C#5','E#5']},
      'Gmaj7': {tri: ['G4','B4','D5'],   tet: ['G4','B4','D5','F#5']},
      'G#maj7': {tri: ['G#4','B#4','D#5'], tet: ['G#4','B#4','D#5','F##5']},
      'Amaj7': {tri: ['A4','C#5','E5'],  tet: ['A4','C#5','E5','G#5']},
      'A#maj7': {tri: ['A#4','C##5','E#5'], tet: ['A#4','C##5','E#5','G##5']},
      'Bmaj7': {tri: ['B4','D#5','F#5'], tet: ['B4','D#5','F#5','A#5']},
      'Cmm': {tri: ['C4','Eb4','Gb4'], tet: ['C4','Eb4','Gb4','A4']},
      'Dmm': {tri: ['D4','F4','Ab4'],  tet: ['D4','F4','Ab4','C5']},
      'Emm': {tri: ['E4','G4','Bb4'],  tet: ['E4','G4','Bb4','D5']},
      'Gmm': {tri: ['G4','Bb4','Db5'], tet: ['G4','Bb4','Db5','E5']},
      'Amm': {tri: ['A4','C5','Eb5'],  tet: ['A4','C5','Eb5','G5']},
      'Bmm': {tri: ['B4','D5','F5'],   tet: ['B4','D5','F5','A5']},
      'Csus2': {tri: ['C4','D4','G4'],   tet: ['C4','D4','G4','B4']},
      'Csus4': {tri: ['C4','F4','G4'],   tet: ['C4','F4','G4','B4']},
      'Dsus2': {tri: ['D4','E4','A4'],   tet: ['D4','E4','A4','C#5']},
      'Dsus4': {tri: ['D4','G4','A4'],   tet: ['D4','G4','A4','C#5']},
      'Esus2': {tri: ['E4','F#4','B4'],  tet: ['E4','F#4','B4','D#5']},
      'Esus4': {tri: ['E4','A4','B4'],   tet: ['E4','A4','B4','D#5']},
      'Fsus2': {tri: ['F4','G4','C5'],   tet: ['F4','G4','C5','E5']},
      'Fsus4': {tri: ['F4','Bb4','C5'],  tet: ['F4','Bb4','C5','E5']},
      'Gsus2': {tri: ['G4','A4','D5'],   tet: ['G4','A4','D5','F#5']},
      'Gsus4': {tri: ['G4','C5','D5'],   tet: ['G4','C5','D5','F#5']},
      'Asus2': {tri: ['A4','B4','E5'],   tet: ['A4','B4','E5','G#5']},
      'Asus4': {tri: ['A4','D5','E5'],   tet: ['A4','D5','E5','G#5']},
      'Bsus2': {tri: ['B4','C#5','F#5'], tet: ['B4','C#5','F#5','A#5']},
      'Bsus4': {tri: ['B4','E5','F#5'],  tet: ['B4','E5','F#5','A#5']}
    };

    function computeVoicing(chordName, mode, inversion) {
        if (!chordName) return [];
        const norm = chordName.replace(/^H/i, 'B');

        // Handle slash chords: e.g., C/E, Am/G
        const parts = norm.split('/');
        const base = parts[0];
        const bass = parts[1] ? parts[1].toUpperCase() : null;

        const entry = CHORD_TABLE[base];
        if (!entry) return [];

        let notes = mode === 'tetrad' ? entry.tet : entry.tri;

        // Convert enharmonic spellings to match piano keys (only sharps on piano)
        notes = notes.map(n => {
            n = n.replace('Eb', 'D#').replace('Ab', 'G#').replace('Bb', 'A#');
            n = n.replace('Db', 'C#').replace('Gb', 'F#');
            n = n.replace('Cb', 'B').replace('Fb', 'E');
            // Remove theoretical double sharps/flats
            n = n.replace('##', '').replace('bb', '');
            n = n.replace('E#', 'F').replace('B#', 'C');
            // Clamp to octave 4 for 1-octave piano
            n = n.replace(/[45]$/, '4');
            return n;
        });

        // If slash bass provided, move that note to the front (bass)
        if (bass) {
            let bassNote = bass.replace(/^H/, 'B');
            bassNote = bassNote.replace('EB','D#').replace('AB','G#').replace('BB','A#');
            bassNote = bassNote.replace('DB','C#').replace('GB','F#');
            bassNote = bassNote.replace('CB','B').replace('FB','E');
            bassNote = bassNote.replace('E#', 'F').replace('B#', 'C');
            bassNote = bassNote + '4';
            // Remove duplicates and unshift bass
            notes = notes.filter(n => n.replace(/[45]$/, '') !== bassNote.replace(/[45]$/, ''));
            notes.unshift(bassNote);
        }

        if (!notes.length) return notes;
        const inv = Math.abs(inversion) % notes.length;
        return notes.slice(inv).concat(notes.slice(0, inv));
    }

    function analyzeChord(chordName) {
        return {
            type: 'Chord',
            intervals: ['R', 'M3', 'P5'],
            quality: 'Major',
            position: 'Root Position'
        };
    }

    // ===== AUDIO (match integration.html) =====
    
    let AUDIO_CTX = null, AUDIO_MASTER = null;

    function getAudio() {
        if (!AUDIO_CTX) {
            const Ctx = window.AudioContext || window.webkitAudioContext;
            AUDIO_CTX = new Ctx();
            AUDIO_MASTER = AUDIO_CTX.createGain();
            AUDIO_MASTER.gain.value = 0.2;
            AUDIO_MASTER.connect(AUDIO_CTX.destination);
        }
        return { ctx: AUDIO_CTX, master: AUDIO_MASTER };
    }

    function noteToFreq(note) {
        if (!note) return 440;
        const m = note.match(/^([A-GH])([#b]?)(\d)$/i);
        if (!m) return 440;
        let [, ltr, acc, oct] = m; oct = parseInt(oct, 10);
        const name = ltr.toUpperCase() === 'H' ? 'B' : ltr.toUpperCase();
        const key = (name + (acc || '')).toUpperCase();
        const semis = { C:0,'C#':1,DB:1,D:2,'D#':3,EB:3,E:4,F:5,'F#':6,GB:6,G:7,'G#':8,AB:8,A:9,'A#':10,BB:10,B:11 };
        const semi = semis[key];
        if (semi === undefined) return 440;
        const midi = (oct + 1) * 12 + semi;
        return 440 * Math.pow(2, (midi - 69) / 12);
    }

    function triggerTone(freq, dur = 0.8, when = 0, detune = 0) {
        const { ctx, master } = getAudio();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = 'sine';
        osc.frequency.value = freq;
        osc.detune.value = detune;
        gain.gain.setValueAtTime(0.0001, ctx.currentTime + when);
        gain.gain.exponentialRampToValueAtTime(1.0, ctx.currentTime + when + 0.01);
        gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + when + dur);
        osc.connect(gain).connect(master);
        osc.start(ctx.currentTime + when);
        osc.stop(ctx.currentTime + when + dur + 0.05);
    }

    // ===== AUDIO PLAYBACK =====
    
    function playChord(notes) {
        if (!Array.isArray(notes) || !notes.length) return;
        console.log(`[R3] Playing chord: ${notes.join(', ')}`);
        notes.forEach((n, idx) => {
            const f = noteToFreq(n);
            const detune = (idx - (notes.length - 1) / 2) * 4; // slight spread
            triggerTone(f, 1.0, 0, detune);
        });
    }

    function playNote(note) {
        console.log(`[R3] Playing note: ${note}`);
        const f = noteToFreq(note);
        triggerTone(f, 0.5, 0, 0);
    }

    // ===== BUTTON HANDLERS =====
    
    function attachButtonListeners() {
        console.log('[R3] attachButtonListeners called');
        const controls = document.getElementById('r3-controls-1');
        console.log('[R3] Controls element:', controls);
        
        if (!controls) {
            console.error('[R3] Controls element not found!');
            return;
        }
        
        controls.addEventListener('click', (event) => {
            const btn = event.target.closest('.r3-btn');
            if (!btn) return;

            const action = btn.getAttribute('data-action');
            handleGroupAction(action);
        });
    }

    function updateGroupButtons() {
        const triadBtn = document.querySelector('[data-action="triad"]');
        const tetradBtn = document.querySelector('[data-action="tetrad"]');

        if (triadBtn) triadBtn.classList.toggle('active', groupState.mode === 'triad');
        if (tetradBtn) tetradBtn.classList.toggle('active', groupState.mode === 'tetrad');
    }

    function handleGroupAction(action) {
        switch (action) {
            case 'play':
                if (groupState.notes && groupState.notes.length > 0) {
                    playChord(groupState.notes);
                }
                break;
            case 'triad':
                groupState.mode = 'triad';
                if (groupState.chordName) {
                    groupState.notes = computeVoicing(groupState.chordName, groupState.mode, groupState.inversion);
                    updateChordDisplay(groupState.chordName, groupState.notes);
                    sendToR2B();
                }
                updateGroupButtons();
                break;
            case 'tetrad':
                groupState.mode = 'tetrad';
                if (groupState.chordName) {
                    groupState.notes = computeVoicing(groupState.chordName, groupState.mode, groupState.inversion);
                    updateChordDisplay(groupState.chordName, groupState.notes);
                    sendToR2B();
                }
                updateGroupButtons();
                break;
            case 'invert':
                groupState.inversion = (groupState.inversion + 1) % 4;
                if (groupState.chordName) {
                    groupState.notes = computeVoicing(groupState.chordName, groupState.mode, groupState.inversion);
                    updateChordDisplay(groupState.chordName, groupState.notes);
                    sendToR2B();
                }
                break;
            case 'send':
                sendToR2B();
                break;
            default:
                break;
        }
    }

    function sendToR2B() {
        if (!groupState.chordName) {
            console.log('R3: No chord to send to R2B');
            return;
        }

        // Format chord name with inversion info
        let displayName = groupState.chordName;
        if (groupState.inversion > 0) {
            const invNames = ['', '1st inv', '2nd inv', '3rd inv'];
            displayName = `${groupState.chordName} (${invNames[groupState.inversion]})`;
        }

        const payload = {
            chordName: displayName,
            notes: groupState.notes,
            mode: groupState.mode,
            inversion: groupState.inversion,
            analysis: analyzeChord(groupState.chordName),
            source: 'R3',
            timestamp: Date.now()
        };
        
        // Send to R2B via postMessage to parent
        window.parent.postMessage({
            type: 'R3_SEND_TO_R2B',
            payload: payload
        }, '*');
        console.log('[R3] Sent to R2B via postMessage:', payload);
    }

    // ===== POSTMESSAGE LISTENER =====
    
    window.addEventListener('message', (event) => {
        console.log('[R3] Received message:', event.data.type);
        
        if (event.data.type === 'R1_LOAD_CHORD') {
            // Single chord from R1 B1
            const { chord, rowIndex } = event.data;
            receiveChordFromR1(chord, rowIndex);
        }
        else if (event.data.type === 'R1_LOAD_ALL') {
            // All chords from R1 B3
            const { chords } = event.data;
            chords.forEach((chord, index) => {
                if (chord) {
                    receiveChordFromR1(chord, index + 1);
                }
            });
        }
        else if (event.data.type === 'R1_CLEAR_ROW') {
            // Clear single row from R1 B2
            const { rowIndex } = event.data;
            clearPianoGroup(rowIndex);
        }
        else if (event.data.type === 'R1_CLEAR_ALL') {
            // Clear all from R1 B4
            for (let i = 1; i <= 24; i++) {
                clearPianoGroup(i);
            }
        }
    });
</script>

</body>
</html>
